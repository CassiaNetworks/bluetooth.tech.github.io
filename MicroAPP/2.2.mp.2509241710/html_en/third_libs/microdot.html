

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>microdot &mdash; Micro APP 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3abfe436" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="MicroPython Libraries" href="../micropython_libs/index.html" />
    <link rel="prev" title="micropython-mqtt" href="micropython_mqtt.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Micro APP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resource/index.html">Version &amp; Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassiablue_api/index.html">Cassiablue API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassiamqtt_api/index.html">Cassiamqtt API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassia_libs/index.html">Cassia Common Libraries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Common Third-Party Libraries</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="aiohttp.html">aiohttp</a></li>
<li class="toctree-l2"><a class="reference internal" href="micropython_mqtt.html">micropython-mqtt</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">microdot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">Example</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id3">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../micropython_libs/index.html">MicroPython Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../more/index.html">More Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Micro APP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Common Third-Party Libraries</a></li>
      <li class="breadcrumb-item active">microdot</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/third_libs/microdot.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="microdot">
<h1>microdot<a class="headerlink" href="#microdot" title="Link to this heading"></a></h1>
<p>To provide HTTP services, you can use the open-source <code class="docutils literal notranslate"><span class="pre">microdot</span></code> library. Refer <a class="reference external" href="https://github.com/miguelgrinberg/microdot">microdot</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>This library is not integrated by default in the gateway and must be manually included in your script for use.</p></li>
<li><p>For larger static pages, consider using cloud-hosted static resources.</p></li>
</ul>
</div>
<section id="id2">
<h2>Example<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<section id="id3">
<h3>Description<a class="headerlink" href="#id3" title="Link to this heading"></a></h3>
<p>The example uses Microdot to provide an HTTP service on port 60000 and registers three routes.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/</span></code>: Serve static page responses</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/hello</span></code>: Return JSON Responses</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/app/config/meta</span></code>: Return JSON responses for RESTful API requests from static pages.</p></li>
</ul>
</section>
<section id="id4">
<h3>Code<a class="headerlink" href="#id4" title="Link to this heading"></a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">   1</span><span class="c1"># ===========================</span>
<span class="linenos">   2</span><span class="c1"># microdot</span>
<span class="linenos">   3</span><span class="c1"># ===========================</span>
<span class="linenos">   4</span>
<span class="linenos">   5</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">   6</span><span class="sd">microdot</span>
<span class="linenos">   7</span><span class="sd">--------</span>
<span class="linenos">   8</span><span class="sd">https://microdot.readthedocs.io/en/stable/intro.html#running-with-micropython</span>
<span class="linenos">   9</span>
<span class="linenos">  10</span><span class="sd">The ``microdot`` module defines a few classes that help implement HTTP-based</span>
<span class="linenos">  11</span><span class="sd">servers for MicroPython and standard Python.</span>
<span class="linenos">  12</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  13</span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">  14</span><span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="linenos">  15</span><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="linenos">  16</span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="linenos">  17</span>
<span class="linenos">  18</span><span class="k">try</span><span class="p">:</span>
<span class="linenos">  19</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">orjson</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos">  20</span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="linenos">  21</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos">  22</span>
<span class="linenos">  23</span><span class="k">try</span><span class="p">:</span>
<span class="linenos">  24</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">iscoroutinefunction</span><span class="p">,</span> <span class="n">iscoroutine</span>
<span class="linenos">  25</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="linenos">  26</span>
<span class="linenos">  27</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">  28</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoke a handler and return the result.</span>
<span class="linenos">  29</span>
<span class="linenos">  30</span><span class="sd">        This method runs sync handlers in a thread pool executor.</span>
<span class="linenos">  31</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">  32</span>        <span class="k">if</span> <span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
<span class="linenos">  33</span>            <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  34</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">  35</span>            <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
<span class="linenos">  36</span>                <span class="kc">None</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  37</span>            <span class="p">)</span>
<span class="linenos">  38</span>        <span class="k">return</span> <span class="n">ret</span>
<span class="linenos">  39</span>
<span class="linenos">  40</span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">  41</span>
<span class="linenos">  42</span>    <span class="k">def</span><span class="w"> </span><span class="nf">iscoroutine</span><span class="p">(</span><span class="n">coro</span><span class="p">):</span>
<span class="linenos">  43</span>        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="s2">&quot;send&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="s2">&quot;throw&quot;</span><span class="p">)</span>
<span class="linenos">  44</span>
<span class="linenos">  45</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos">  46</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Invoke a handler and return the result.</span>
<span class="linenos">  47</span>
<span class="linenos">  48</span><span class="sd">        This method runs sync handlers in the asyncio thread, which can</span>
<span class="linenos">  49</span><span class="sd">        potentially cause blocking and performance issues.</span>
<span class="linenos">  50</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">  51</span>        <span class="n">ret</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="linenos">  52</span>        <span class="k">if</span> <span class="n">iscoroutine</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
<span class="linenos">  53</span>            <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ret</span>
<span class="linenos">  54</span>        <span class="k">return</span> <span class="n">ret</span>
<span class="linenos">  55</span>
<span class="linenos">  56</span>
<span class="linenos">  57</span><span class="k">try</span><span class="p">:</span>
<span class="linenos">  58</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">sys</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_exception</span>
<span class="linenos">  59</span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">  60</span>    <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="linenos">  61</span>
<span class="linenos">  62</span>    <span class="k">def</span><span class="w"> </span><span class="nf">print_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
<span class="linenos">  63</span>        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<span class="linenos">  64</span>
<span class="linenos">  65</span>
<span class="linenos">  66</span><span class="n">MUTED_SOCKET_ERRORS</span> <span class="o">=</span> <span class="p">[</span>
<span class="linenos">  67</span>    <span class="mi">32</span><span class="p">,</span>  <span class="c1"># Broken pipe</span>
<span class="linenos">  68</span>    <span class="mi">54</span><span class="p">,</span>  <span class="c1"># Connection reset by peer</span>
<span class="linenos">  69</span>    <span class="mi">104</span><span class="p">,</span>  <span class="c1"># Connection reset by peer</span>
<span class="linenos">  70</span>    <span class="mi">128</span><span class="p">,</span>  <span class="c1"># Operation on closed socket</span>
<span class="linenos">  71</span><span class="p">]</span>
<span class="linenos">  72</span>
<span class="linenos">  73</span>
<span class="linenos">  74</span><span class="k">def</span><span class="w"> </span><span class="nf">urldecode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="linenos">  75</span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">  76</span>        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="linenos">  77</span>    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
<span class="linenos">  78</span>    <span class="n">parts</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
<span class="linenos">  79</span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="linenos">  80</span>        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="linenos">  81</span>    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="linenos">  82</span>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<span class="linenos">  83</span>        <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
<span class="linenos">  84</span>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;%&quot;</span><span class="p">)</span>
<span class="linenos">  85</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">  86</span>            <span class="n">code</span> <span class="o">=</span> <span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="linenos">  87</span>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mi">16</span><span class="p">)]))</span>
<span class="linenos">  88</span>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
<span class="linenos">  89</span>    <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="linenos">  90</span>
<span class="linenos">  91</span>
<span class="linenos">  92</span><span class="k">def</span><span class="w"> </span><span class="nf">urlencode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="linenos">  93</span>    <span class="k">return</span> <span class="p">(</span>
<span class="linenos">  94</span>        <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;%2B&quot;</span><span class="p">)</span>
<span class="linenos">  95</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">)</span>
<span class="linenos">  96</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;%25&quot;</span><span class="p">)</span>
<span class="linenos">  97</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%3F</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">  98</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="s2">&quot;%23&quot;</span><span class="p">)</span>
<span class="linenos">  99</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;%26&quot;</span><span class="p">)</span>
<span class="linenos"> 100</span>        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;%3D&quot;</span><span class="p">)</span>
<span class="linenos"> 101</span>    <span class="p">)</span>
<span class="linenos"> 102</span>
<span class="linenos"> 103</span>
<span class="linenos"> 104</span><span class="k">class</span><span class="w"> </span><span class="nc">NoCaseDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 105</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;A subclass of dictionary that holds case-insensitive keys.</span>
<span class="linenos"> 106</span>
<span class="linenos"> 107</span><span class="sd">    :param initial_dict: an initial dictionary of key/value pairs to</span>
<span class="linenos"> 108</span><span class="sd">                         initialize this object with.</span>
<span class="linenos"> 109</span>
<span class="linenos"> 110</span><span class="sd">    Example::</span>
<span class="linenos"> 111</span>
<span class="linenos"> 112</span><span class="sd">        &gt;&gt;&gt; d = NoCaseDict()</span>
<span class="linenos"> 113</span><span class="sd">        &gt;&gt;&gt; d[&#39;Content-Type&#39;] = &#39;text/html&#39;</span>
<span class="linenos"> 114</span><span class="sd">        &gt;&gt;&gt; print(d[&#39;Content-Type&#39;])</span>
<span class="linenos"> 115</span><span class="sd">        text/html</span>
<span class="linenos"> 116</span><span class="sd">        &gt;&gt;&gt; print(d[&#39;content-type&#39;])</span>
<span class="linenos"> 117</span><span class="sd">        text/html</span>
<span class="linenos"> 118</span><span class="sd">        &gt;&gt;&gt; print(d[&#39;CONTENT-TYPE&#39;])</span>
<span class="linenos"> 119</span><span class="sd">        text/html</span>
<span class="linenos"> 120</span><span class="sd">        &gt;&gt;&gt; del d[&#39;cOnTeNt-TyPe&#39;]</span>
<span class="linenos"> 121</span><span class="sd">        &gt;&gt;&gt; print(d)</span>
<span class="linenos"> 122</span><span class="sd">        {}</span>
<span class="linenos"> 123</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 124</span>
<span class="linenos"> 125</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 126</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">initial_dict</span> <span class="ow">or</span> <span class="p">{})</span>
<span class="linenos"> 127</span>        <span class="bp">self</span><span class="o">.</span><span class="n">keymap</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="n">k</span><span class="p">}</span>
<span class="linenos"> 128</span>
<span class="linenos"> 129</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 130</span>        <span class="n">kl</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 131</span>        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
<span class="linenos"> 132</span>        <span class="k">if</span> <span class="n">kl</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
<span class="linenos"> 133</span>            <span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="p">[</span><span class="n">kl</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
<span class="linenos"> 134</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos"> 135</span>
<span class="linenos"> 136</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos"> 137</span>        <span class="n">kl</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 138</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">kl</span><span class="p">))</span>
<span class="linenos"> 139</span>
<span class="linenos"> 140</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos"> 141</span>        <span class="n">kl</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 142</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">kl</span><span class="p">))</span>
<span class="linenos"> 143</span>
<span class="linenos"> 144</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos"> 145</span>        <span class="n">kl</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 146</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">kl</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="linenos"> 147</span>
<span class="linenos"> 148</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 149</span>        <span class="n">kl</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="linenos"> 150</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keymap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">kl</span><span class="p">),</span> <span class="n">default</span><span class="p">)</span>
<span class="linenos"> 151</span>
<span class="linenos"> 152</span>    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_dict</span><span class="p">):</span>
<span class="linenos"> 153</span>        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 154</span>            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 155</span>
<span class="linenos"> 156</span>
<span class="linenos"> 157</span><span class="k">def</span><span class="w"> </span><span class="nf">mro</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 158</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the method resolution order of a class.</span>
<span class="linenos"> 159</span>
<span class="linenos"> 160</span><span class="sd">    This is a helper function that returns the method resolution order of a</span>
<span class="linenos"> 161</span><span class="sd">    class. It is used by Microdot to find the best error handler to invoke for</span>
<span class="linenos"> 162</span><span class="sd">    the raised exception.</span>
<span class="linenos"> 163</span>
<span class="linenos"> 164</span><span class="sd">    In CPython, this function returns the ``__mro__`` attribute of the class.</span>
<span class="linenos"> 165</span><span class="sd">    In MicroPython, this function implements a recursive depth-first scanning</span>
<span class="linenos"> 166</span><span class="sd">    of the class hierarchy.</span>
<span class="linenos"> 167</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 168</span>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;mro&quot;</span><span class="p">):</span>
<span class="linenos"> 169</span>        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span>
<span class="linenos"> 170</span>
<span class="linenos"> 171</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_mro</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="linenos"> 172</span>        <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="bp">cls</span><span class="p">]</span>
<span class="linenos"> 173</span>        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
<span class="linenos"> 174</span>            <span class="n">m</span> <span class="o">+=</span> <span class="n">_mro</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="linenos"> 175</span>        <span class="k">return</span> <span class="n">m</span>
<span class="linenos"> 176</span>
<span class="linenos"> 177</span>    <span class="n">mro_list</span> <span class="o">=</span> <span class="n">_mro</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
<span class="linenos"> 178</span>
<span class="linenos"> 179</span>    <span class="c1"># If a class appears multiple times (due to multiple inheritance) remove</span>
<span class="linenos"> 180</span>    <span class="c1"># all but the last occurence. This matches the method resolution order</span>
<span class="linenos"> 181</span>    <span class="c1"># of MicroPython, but not CPython.</span>
<span class="linenos"> 182</span>    <span class="n">mro_pruned</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 183</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mro_list</span><span class="p">)):</span>
<span class="linenos"> 184</span>        <span class="n">base</span> <span class="o">=</span> <span class="n">mro_list</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 185</span>        <span class="k">if</span> <span class="n">base</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mro_list</span><span class="p">:</span>
<span class="linenos"> 186</span>            <span class="n">mro_pruned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
<span class="linenos"> 187</span>    <span class="k">return</span> <span class="n">mro_pruned</span>
<span class="linenos"> 188</span>
<span class="linenos"> 189</span>
<span class="linenos"> 190</span><span class="k">class</span><span class="w"> </span><span class="nc">MultiDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="linenos"> 191</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;A subclass of dictionary that can hold multiple values for the same</span>
<span class="linenos"> 192</span><span class="sd">    key. It is used to hold key/value pairs decoded from query strings and</span>
<span class="linenos"> 193</span><span class="sd">    form submissions.</span>
<span class="linenos"> 194</span>
<span class="linenos"> 195</span><span class="sd">    :param initial_dict: an initial dictionary of key/value pairs to</span>
<span class="linenos"> 196</span><span class="sd">                         initialize this object with.</span>
<span class="linenos"> 197</span>
<span class="linenos"> 198</span><span class="sd">    Example::</span>
<span class="linenos"> 199</span>
<span class="linenos"> 200</span><span class="sd">        &gt;&gt;&gt; d = MultiDict()</span>
<span class="linenos"> 201</span><span class="sd">        &gt;&gt;&gt; d[&#39;sort&#39;] = &#39;name&#39;</span>
<span class="linenos"> 202</span><span class="sd">        &gt;&gt;&gt; d[&#39;sort&#39;] = &#39;email&#39;</span>
<span class="linenos"> 203</span><span class="sd">        &gt;&gt;&gt; print(d[&#39;sort&#39;])</span>
<span class="linenos"> 204</span><span class="sd">        &#39;name&#39;</span>
<span class="linenos"> 205</span><span class="sd">        &gt;&gt;&gt; print(d.getlist(&#39;sort&#39;))</span>
<span class="linenos"> 206</span><span class="sd">        [&#39;name&#39;, &#39;email&#39;]</span>
<span class="linenos"> 207</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 208</span>
<span class="linenos"> 209</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 210</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 211</span>        <span class="k">if</span> <span class="n">initial_dict</span><span class="p">:</span>
<span class="linenos"> 212</span>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">initial_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 213</span>                <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 214</span>
<span class="linenos"> 215</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos"> 216</span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="linenos"> 217</span>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
<span class="linenos"> 218</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 219</span>
<span class="linenos"> 220</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="linenos"> 221</span>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 222</span>
<span class="linenos"> 223</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 224</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the value for a given key.</span>
<span class="linenos"> 225</span>
<span class="linenos"> 226</span><span class="sd">        :param key: The key to retrieve.</span>
<span class="linenos"> 227</span><span class="sd">        :param default: A default value to use if the key does not exist.</span>
<span class="linenos"> 228</span><span class="sd">        :param type: A type conversion callable to apply to the value.</span>
<span class="linenos"> 229</span>
<span class="linenos"> 230</span><span class="sd">        If the multidict contains more than one value for the requested key,</span>
<span class="linenos"> 231</span><span class="sd">        this method returns the first value only.</span>
<span class="linenos"> 232</span>
<span class="linenos"> 233</span><span class="sd">        Example::</span>
<span class="linenos"> 234</span>
<span class="linenos"> 235</span><span class="sd">            &gt;&gt;&gt; d = MultiDict()</span>
<span class="linenos"> 236</span><span class="sd">            &gt;&gt;&gt; d[&#39;age&#39;] = &#39;42&#39;</span>
<span class="linenos"> 237</span><span class="sd">            &gt;&gt;&gt; d.get(&#39;age&#39;)</span>
<span class="linenos"> 238</span><span class="sd">            &#39;42&#39;</span>
<span class="linenos"> 239</span><span class="sd">            &gt;&gt;&gt; d.get(&#39;age&#39;, type=int)</span>
<span class="linenos"> 240</span><span class="sd">            42</span>
<span class="linenos"> 241</span><span class="sd">            &gt;&gt;&gt; d.get(&#39;name&#39;, default=&#39;noname&#39;)</span>
<span class="linenos"> 242</span><span class="sd">            &#39;noname&#39;</span>
<span class="linenos"> 243</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 244</span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="linenos"> 245</span>            <span class="k">return</span> <span class="n">default</span>
<span class="linenos"> 246</span>        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="linenos"> 247</span>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 248</span>            <span class="n">value</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 249</span>        <span class="k">return</span> <span class="n">value</span>
<span class="linenos"> 250</span>
<span class="linenos"> 251</span>    <span class="k">def</span><span class="w"> </span><span class="nf">getlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 252</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all the values for a given key.</span>
<span class="linenos"> 253</span>
<span class="linenos"> 254</span><span class="sd">        :param key: The key to retrieve.</span>
<span class="linenos"> 255</span><span class="sd">        :param type: A type conversion callable to apply to the values.</span>
<span class="linenos"> 256</span>
<span class="linenos"> 257</span><span class="sd">        If the requested key does not exist in the dictionary, this method</span>
<span class="linenos"> 258</span><span class="sd">        returns an empty list.</span>
<span class="linenos"> 259</span>
<span class="linenos"> 260</span><span class="sd">        Example::</span>
<span class="linenos"> 261</span>
<span class="linenos"> 262</span><span class="sd">            &gt;&gt;&gt; d = MultiDict()</span>
<span class="linenos"> 263</span><span class="sd">            &gt;&gt;&gt; d.getlist(&#39;items&#39;)</span>
<span class="linenos"> 264</span><span class="sd">            []</span>
<span class="linenos"> 265</span><span class="sd">            &gt;&gt;&gt; d[&#39;items&#39;] = &#39;3&#39;</span>
<span class="linenos"> 266</span><span class="sd">            &gt;&gt;&gt; d.getlist(&#39;items&#39;)</span>
<span class="linenos"> 267</span><span class="sd">            [&#39;3&#39;]</span>
<span class="linenos"> 268</span><span class="sd">            &gt;&gt;&gt; d[&#39;items&#39;] = &#39;56&#39;</span>
<span class="linenos"> 269</span><span class="sd">            &gt;&gt;&gt; d.getlist(&#39;items&#39;)</span>
<span class="linenos"> 270</span><span class="sd">            [&#39;3&#39;, &#39;56&#39;]</span>
<span class="linenos"> 271</span><span class="sd">            &gt;&gt;&gt; d.getlist(&#39;items&#39;, type=int)</span>
<span class="linenos"> 272</span><span class="sd">            [3, 56]</span>
<span class="linenos"> 273</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 274</span>        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
<span class="linenos"> 275</span>            <span class="k">return</span> <span class="p">[]</span>
<span class="linenos"> 276</span>        <span class="n">values</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
<span class="linenos"> 277</span>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 278</span>            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
<span class="linenos"> 279</span>        <span class="k">return</span> <span class="n">values</span>
<span class="linenos"> 280</span>
<span class="linenos"> 281</span>
<span class="linenos"> 282</span><span class="k">class</span><span class="w"> </span><span class="nc">AsyncBytesIO</span><span class="p">:</span>
<span class="linenos"> 283</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;An async wrapper for BytesIO.&quot;&quot;&quot;</span>
<span class="linenos"> 284</span>
<span class="linenos"> 285</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="linenos"> 286</span>        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 287</span>
<span class="linenos"> 288</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="linenos"> 289</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 290</span>
<span class="linenos"> 291</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 292</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="linenos"> 293</span>
<span class="linenos"> 294</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">readexactly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 295</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="linenos"> 296</span>
<span class="linenos"> 297</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">readuntil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 298</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">readuntil</span><span class="p">(</span><span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>
<span class="linenos"> 299</span>
<span class="linenos"> 300</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">awrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 301</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos"> 302</span>
<span class="linenos"> 303</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 304</span>        <span class="k">pass</span>
<span class="linenos"> 305</span>
<span class="linenos"> 306</span>
<span class="linenos"> 307</span><span class="k">class</span><span class="w"> </span><span class="nc">Request</span><span class="p">:</span>
<span class="linenos"> 308</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;An HTTP request.&quot;&quot;&quot;</span>
<span class="linenos"> 309</span>
<span class="linenos"> 310</span>    <span class="c1">#: Specify the maximum payload size that is accepted. Requests with larger</span>
<span class="linenos"> 311</span>    <span class="c1">#: payloads will be rejected with a 413 status code. Applications can</span>
<span class="linenos"> 312</span>    <span class="c1">#: change this maximum as necessary.</span>
<span class="linenos"> 313</span>    <span class="c1">#:</span>
<span class="linenos"> 314</span>    <span class="c1">#: Example::</span>
<span class="linenos"> 315</span>    <span class="c1">#:</span>
<span class="linenos"> 316</span>    <span class="c1">#:    Request.max_content_length = 1 * 1024 * 1024  # 1MB requests allowed</span>
<span class="linenos"> 317</span>    <span class="n">max_content_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 318</span>
<span class="linenos"> 319</span>    <span class="c1">#: Specify the maximum payload size that can be stored in ``body``.</span>
<span class="linenos"> 320</span>    <span class="c1">#: Requests with payloads that are larger than this size and up to</span>
<span class="linenos"> 321</span>    <span class="c1">#: ``max_content_length`` bytes will be accepted, but the application will</span>
<span class="linenos"> 322</span>    <span class="c1">#: only be able to access the body of the request by reading from</span>
<span class="linenos"> 323</span>    <span class="c1">#: ``stream``. Set to 0 if you always access the body as a stream.</span>
<span class="linenos"> 324</span>    <span class="c1">#:</span>
<span class="linenos"> 325</span>    <span class="c1">#: Example::</span>
<span class="linenos"> 326</span>    <span class="c1">#:</span>
<span class="linenos"> 327</span>    <span class="c1">#:    Request.max_body_length = 4 * 1024  # up to 4KB bodies read</span>
<span class="linenos"> 328</span>    <span class="n">max_body_length</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 329</span>
<span class="linenos"> 330</span>    <span class="c1">#: Specify the maximum length allowed for a line in the request. Requests</span>
<span class="linenos"> 331</span>    <span class="c1">#: with longer lines will not be correctly interpreted. Applications can</span>
<span class="linenos"> 332</span>    <span class="c1">#: change this maximum as necessary.</span>
<span class="linenos"> 333</span>    <span class="c1">#:</span>
<span class="linenos"> 334</span>    <span class="c1">#: Example::</span>
<span class="linenos"> 335</span>    <span class="c1">#:</span>
<span class="linenos"> 336</span>    <span class="c1">#:    Request.max_readline = 16 * 1024  # 16KB lines allowed</span>
<span class="linenos"> 337</span>    <span class="n">max_readline</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos"> 338</span>
<span class="linenos"> 339</span>    <span class="k">class</span><span class="w"> </span><span class="nc">G</span><span class="p">:</span>
<span class="linenos"> 340</span>        <span class="k">pass</span>
<span class="linenos"> 341</span>
<span class="linenos"> 342</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos"> 343</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 344</span>        <span class="n">app</span><span class="p">,</span>
<span class="linenos"> 345</span>        <span class="n">client_addr</span><span class="p">,</span>
<span class="linenos"> 346</span>        <span class="n">method</span><span class="p">,</span>
<span class="linenos"> 347</span>        <span class="n">url</span><span class="p">,</span>
<span class="linenos"> 348</span>        <span class="n">http_version</span><span class="p">,</span>
<span class="linenos"> 349</span>        <span class="n">headers</span><span class="p">,</span>
<span class="linenos"> 350</span>        <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 351</span>        <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 352</span>        <span class="n">sock</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 353</span>        <span class="n">url_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos"> 354</span>        <span class="n">subapp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 355</span>    <span class="p">):</span>
<span class="linenos"> 356</span>        <span class="c1">#: The application instance to which this request belongs.</span>
<span class="linenos"> 357</span>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
<span class="linenos"> 358</span>        <span class="c1">#: The address of the client, as a tuple (host, port).</span>
<span class="linenos"> 359</span>        <span class="bp">self</span><span class="o">.</span><span class="n">client_addr</span> <span class="o">=</span> <span class="n">client_addr</span>
<span class="linenos"> 360</span>        <span class="c1">#: The HTTP method of the request.</span>
<span class="linenos"> 361</span>        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
<span class="linenos"> 362</span>        <span class="c1">#: The request URL, including the path and query string.</span>
<span class="linenos"> 363</span>        <span class="bp">self</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">url</span>
<span class="linenos"> 364</span>        <span class="c1">#: The URL prefix, if the endpoint comes from a mounted</span>
<span class="linenos"> 365</span>        <span class="c1">#: sub-application, or else &#39;&#39;.</span>
<span class="linenos"> 366</span>        <span class="bp">self</span><span class="o">.</span><span class="n">url_prefix</span> <span class="o">=</span> <span class="n">url_prefix</span>
<span class="linenos"> 367</span>        <span class="c1">#: The sub-application instance, or `None` if this isn&#39;t a mounted</span>
<span class="linenos"> 368</span>        <span class="c1">#: endpoint.</span>
<span class="linenos"> 369</span>        <span class="bp">self</span><span class="o">.</span><span class="n">subapp</span> <span class="o">=</span> <span class="n">subapp</span>
<span class="linenos"> 370</span>        <span class="c1">#: The path portion of the URL.</span>
<span class="linenos"> 371</span>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">url</span>
<span class="linenos"> 372</span>        <span class="c1">#: The query string portion of the URL.</span>
<span class="linenos"> 373</span>        <span class="bp">self</span><span class="o">.</span><span class="n">query_string</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 374</span>        <span class="c1">#: The parsed query string, as a</span>
<span class="linenos"> 375</span>        <span class="c1">#: :class:`MultiDict &lt;microdot.MultiDict&gt;` object.</span>
<span class="linenos"> 376</span>        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 377</span>        <span class="c1">#: A dictionary with the headers included in the request.</span>
<span class="linenos"> 378</span>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">headers</span>
<span class="linenos"> 379</span>        <span class="c1">#: A dictionary with the cookies included in the request.</span>
<span class="linenos"> 380</span>        <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 381</span>        <span class="c1">#: The parsed ``Content-Length`` header.</span>
<span class="linenos"> 382</span>        <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 383</span>        <span class="c1">#: The parsed ``Content-Type`` header.</span>
<span class="linenos"> 384</span>        <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 385</span>        <span class="c1">#: A general purpose container for applications to store data during</span>
<span class="linenos"> 386</span>        <span class="c1">#: the life of the request.</span>
<span class="linenos"> 387</span>        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">Request</span><span class="o">.</span><span class="n">G</span><span class="p">()</span>
<span class="linenos"> 388</span>
<span class="linenos"> 389</span>        <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="n">http_version</span>
<span class="linenos"> 390</span>        <span class="k">if</span> <span class="s2">&quot;?&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
<span class="linenos"> 391</span>            <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 392</span>            <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_urlencoded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query_string</span><span class="p">)</span>
<span class="linenos"> 393</span>
<span class="linenos"> 394</span>        <span class="k">if</span> <span class="s2">&quot;Content-Length&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 395</span>            <span class="bp">self</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">])</span>
<span class="linenos"> 396</span>        <span class="k">if</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 397</span>            <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span>
<span class="linenos"> 398</span>        <span class="k">if</span> <span class="s2">&quot;Cookie&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 399</span>            <span class="k">for</span> <span class="n">cookie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Cookie&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">):</span>
<span class="linenos"> 400</span>                <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 401</span>                <span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 402</span>
<span class="linenos"> 403</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_body</span> <span class="o">=</span> <span class="n">body</span>
<span class="linenos"> 404</span>        <span class="bp">self</span><span class="o">.</span><span class="n">body_used</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 405</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">stream</span>
<span class="linenos"> 406</span>        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">sock</span>
<span class="linenos"> 407</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_json</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 408</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 409</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 410</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 411</span>
<span class="linenos"> 412</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 413</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">client_reader</span><span class="p">,</span> <span class="n">client_writer</span><span class="p">,</span> <span class="n">client_addr</span><span class="p">):</span>
<span class="linenos"> 414</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a request object.</span>
<span class="linenos"> 415</span>
<span class="linenos"> 416</span><span class="sd">        :param app: The Microdot application instance.</span>
<span class="linenos"> 417</span><span class="sd">        :param client_reader: An input stream from where the request data can</span>
<span class="linenos"> 418</span><span class="sd">                              be read.</span>
<span class="linenos"> 419</span><span class="sd">        :param client_writer: An output stream where the response data can be</span>
<span class="linenos"> 420</span><span class="sd">                              written.</span>
<span class="linenos"> 421</span><span class="sd">        :param client_addr: The address of the client, as a tuple.</span>
<span class="linenos"> 422</span>
<span class="linenos"> 423</span><span class="sd">        This method is a coroutine. It returns a newly created ``Request``</span>
<span class="linenos"> 424</span><span class="sd">        object.</span>
<span class="linenos"> 425</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 426</span>        <span class="c1"># request line</span>
<span class="linenos"> 427</span>        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">Request</span><span class="o">.</span><span class="n">_safe_readline</span><span class="p">(</span><span class="n">client_reader</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="linenos"> 428</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 429</span>            <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 430</span>        <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">http_version</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="linenos"> 431</span>        <span class="n">http_version</span> <span class="o">=</span> <span class="n">http_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 432</span>
<span class="linenos"> 433</span>        <span class="c1"># headers</span>
<span class="linenos"> 434</span>        <span class="n">headers</span> <span class="o">=</span> <span class="n">NoCaseDict</span><span class="p">()</span>
<span class="linenos"> 435</span>        <span class="n">content_length</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 436</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 437</span>            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">Request</span><span class="o">.</span><span class="n">_safe_readline</span><span class="p">(</span><span class="n">client_reader</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="linenos"> 438</span>            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
<span class="linenos"> 439</span>                <span class="k">break</span>
<span class="linenos"> 440</span>            <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 441</span>            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos"> 442</span>            <span class="n">headers</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
<span class="linenos"> 443</span>            <span class="k">if</span> <span class="n">header</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;content-length&quot;</span><span class="p">:</span>
<span class="linenos"> 444</span>                <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 445</span>
<span class="linenos"> 446</span>        <span class="c1"># body</span>
<span class="linenos"> 447</span>        <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="linenos"> 448</span>        <span class="k">if</span> <span class="n">content_length</span> <span class="ow">and</span> <span class="n">content_length</span> <span class="o">&lt;=</span> <span class="n">Request</span><span class="o">.</span><span class="n">max_body_length</span><span class="p">:</span>
<span class="linenos"> 449</span>            <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client_reader</span><span class="o">.</span><span class="n">readexactly</span><span class="p">(</span><span class="n">content_length</span><span class="p">)</span>
<span class="linenos"> 450</span>            <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 451</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 452</span>            <span class="n">body</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="linenos"> 453</span>            <span class="n">stream</span> <span class="o">=</span> <span class="n">client_reader</span>
<span class="linenos"> 454</span>
<span class="linenos"> 455</span>        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span>
<span class="linenos"> 456</span>            <span class="n">app</span><span class="p">,</span>
<span class="linenos"> 457</span>            <span class="n">client_addr</span><span class="p">,</span>
<span class="linenos"> 458</span>            <span class="n">method</span><span class="p">,</span>
<span class="linenos"> 459</span>            <span class="n">url</span><span class="p">,</span>
<span class="linenos"> 460</span>            <span class="n">http_version</span><span class="p">,</span>
<span class="linenos"> 461</span>            <span class="n">headers</span><span class="p">,</span>
<span class="linenos"> 462</span>            <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span>
<span class="linenos"> 463</span>            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
<span class="linenos"> 464</span>            <span class="n">sock</span><span class="o">=</span><span class="p">(</span><span class="n">client_reader</span><span class="p">,</span> <span class="n">client_writer</span><span class="p">),</span>
<span class="linenos"> 465</span>        <span class="p">)</span>
<span class="linenos"> 466</span>
<span class="linenos"> 467</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_urlencoded</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">urlencoded</span><span class="p">):</span>
<span class="linenos"> 468</span>        <span class="n">data</span> <span class="o">=</span> <span class="n">MultiDict</span><span class="p">()</span>
<span class="linenos"> 469</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">urlencoded</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
<span class="linenos"> 470</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urlencoded</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 471</span>                <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos"> 472</span>                    <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">urlencoded</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pair</span>
<span class="linenos"> 473</span>                <span class="p">]:</span>
<span class="linenos"> 474</span>                    <span class="n">data</span><span class="p">[</span><span class="n">urldecode</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">urldecode</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 475</span>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">urlencoded</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>  <span class="c1"># pragma: no branch</span>
<span class="linenos"> 476</span>                <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="p">[</span>
<span class="linenos"> 477</span>                    <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">urlencoded</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">pair</span>
<span class="linenos"> 478</span>                <span class="p">]:</span>
<span class="linenos"> 479</span>                    <span class="n">data</span><span class="p">[</span><span class="n">urldecode</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">urldecode</span><span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
<span class="linenos"> 480</span>        <span class="k">return</span> <span class="n">data</span>
<span class="linenos"> 481</span>
<span class="linenos"> 482</span>    <span class="nd">@property</span>
<span class="linenos"> 483</span>    <span class="k">def</span><span class="w"> </span><span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 484</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;The body of the request, as bytes.&quot;&quot;&quot;</span>
<span class="linenos"> 485</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_body</span>
<span class="linenos"> 486</span>
<span class="linenos"> 487</span>    <span class="nd">@property</span>
<span class="linenos"> 488</span>    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 489</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;The body of the request, as a bytes stream.&quot;&quot;&quot;</span>
<span class="linenos"> 490</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 491</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span> <span class="o">=</span> <span class="n">AsyncBytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_body</span><span class="p">)</span>
<span class="linenos"> 492</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stream</span>
<span class="linenos"> 493</span>
<span class="linenos"> 494</span>    <span class="nd">@property</span>
<span class="linenos"> 495</span>    <span class="k">def</span><span class="w"> </span><span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 496</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;The parsed JSON body, or ``None`` if the request does not have a</span>
<span class="linenos"> 497</span><span class="sd">        JSON body.&quot;&quot;&quot;</span>
<span class="linenos"> 498</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 499</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 500</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 501</span>            <span class="n">mime_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 502</span>            <span class="k">if</span> <span class="n">mime_type</span> <span class="o">!=</span> <span class="s2">&quot;application/json&quot;</span><span class="p">:</span>
<span class="linenos"> 503</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 504</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
<span class="linenos"> 505</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json</span>
<span class="linenos"> 506</span>
<span class="linenos"> 507</span>    <span class="nd">@property</span>
<span class="linenos"> 508</span>    <span class="k">def</span><span class="w"> </span><span class="nf">form</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 509</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;The parsed form submission body, as a</span>
<span class="linenos"> 510</span><span class="sd">        :class:`MultiDict &lt;microdot.MultiDict&gt;` object, or ``None`` if the</span>
<span class="linenos"> 511</span><span class="sd">        request does not have a form submission.</span>
<span class="linenos"> 512</span>
<span class="linenos"> 513</span><span class="sd">        Forms that are URL encoded are processed by default. For multipart</span>
<span class="linenos"> 514</span><span class="sd">        forms to be processed, the</span>
<span class="linenos"> 515</span><span class="sd">        :func:`with_form_data &lt;microdot.multipart.with_form_data&gt;`</span>
<span class="linenos"> 516</span><span class="sd">        decorator must be added to the route.</span>
<span class="linenos"> 517</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 518</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 519</span>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 520</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 521</span>            <span class="n">mime_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos"> 522</span>            <span class="k">if</span> <span class="n">mime_type</span> <span class="o">!=</span> <span class="s2">&quot;application/x-www-form-urlencoded&quot;</span><span class="p">:</span>
<span class="linenos"> 523</span>                <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 524</span>            <span class="bp">self</span><span class="o">.</span><span class="n">_form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_urlencoded</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 525</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_form</span>
<span class="linenos"> 526</span>
<span class="linenos"> 527</span>    <span class="nd">@property</span>
<span class="linenos"> 528</span>    <span class="k">def</span><span class="w"> </span><span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 529</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;The files uploaded in the request as a dictionary, or ``None`` if</span>
<span class="linenos"> 530</span><span class="sd">        the request does not have any files.</span>
<span class="linenos"> 531</span>
<span class="linenos"> 532</span><span class="sd">        The :func:`with_form_data &lt;microdot.multipart.with_form_data&gt;`</span>
<span class="linenos"> 533</span><span class="sd">        decorator must be added to the route that receives file uploads for</span>
<span class="linenos"> 534</span><span class="sd">        this property to be set.</span>
<span class="linenos"> 535</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 536</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span>
<span class="linenos"> 537</span>
<span class="linenos"> 538</span>    <span class="k">def</span><span class="w"> </span><span class="nf">after_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="linenos"> 539</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a request-specific function to run after the request is</span>
<span class="linenos"> 540</span><span class="sd">        handled. Request-specific after request handlers run at the very end,</span>
<span class="linenos"> 541</span><span class="sd">        after the application&#39;s own after request handlers. The function must</span>
<span class="linenos"> 542</span><span class="sd">        take two arguments, the request and response objects. The return value</span>
<span class="linenos"> 543</span><span class="sd">        of the function must be the updated response object.</span>
<span class="linenos"> 544</span>
<span class="linenos"> 545</span><span class="sd">        Example::</span>
<span class="linenos"> 546</span>
<span class="linenos"> 547</span><span class="sd">            @app.route(&#39;/&#39;)</span>
<span class="linenos"> 548</span><span class="sd">            def index(request):</span>
<span class="linenos"> 549</span><span class="sd">                # register a request-specific after request handler</span>
<span class="linenos"> 550</span><span class="sd">                @req.after_request</span>
<span class="linenos"> 551</span><span class="sd">                def func(request, response):</span>
<span class="linenos"> 552</span><span class="sd">                    # ...</span>
<span class="linenos"> 553</span><span class="sd">                    return response</span>
<span class="linenos"> 554</span>
<span class="linenos"> 555</span><span class="sd">                return &#39;Hello, World!&#39;</span>
<span class="linenos"> 556</span>
<span class="linenos"> 557</span><span class="sd">        Note that the function is not called if the request handler raises an</span>
<span class="linenos"> 558</span><span class="sd">        exception and an error response is returned instead.</span>
<span class="linenos"> 559</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 560</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos"> 561</span>        <span class="k">return</span> <span class="n">f</span>
<span class="linenos"> 562</span>
<span class="linenos"> 563</span>    <span class="nd">@staticmethod</span>
<span class="linenos"> 564</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_safe_readline</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
<span class="linenos"> 565</span>        <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="linenos"> 566</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Request</span><span class="o">.</span><span class="n">max_readline</span><span class="p">:</span>
<span class="linenos"> 567</span>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;line too long&quot;</span><span class="p">)</span>
<span class="linenos"> 568</span>        <span class="k">return</span> <span class="n">line</span>
<span class="linenos"> 569</span>
<span class="linenos"> 570</span>
<span class="linenos"> 571</span><span class="k">class</span><span class="w"> </span><span class="nc">Response</span><span class="p">:</span>
<span class="linenos"> 572</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;An HTTP response class.</span>
<span class="linenos"> 573</span>
<span class="linenos"> 574</span><span class="sd">    :param body: The body of the response. If a dictionary or list is given,</span>
<span class="linenos"> 575</span><span class="sd">                 a JSON formatter is used to generate the body. If a file-like</span>
<span class="linenos"> 576</span><span class="sd">                 object or an async generator is given, a streaming response is</span>
<span class="linenos"> 577</span><span class="sd">                 used. If a string is given, it is encoded from UTF-8. Else,</span>
<span class="linenos"> 578</span><span class="sd">                 the body should be a byte sequence.</span>
<span class="linenos"> 579</span><span class="sd">    :param status_code: The numeric HTTP status code of the response. The</span>
<span class="linenos"> 580</span><span class="sd">                        default is 200.</span>
<span class="linenos"> 581</span><span class="sd">    :param headers: A dictionary of headers to include in the response.</span>
<span class="linenos"> 582</span><span class="sd">    :param reason: A custom reason phrase to add after the status code. The</span>
<span class="linenos"> 583</span><span class="sd">                   default is &quot;OK&quot; for responses with a 200 status code and</span>
<span class="linenos"> 584</span><span class="sd">                   &quot;N/A&quot; for any other status codes.</span>
<span class="linenos"> 585</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 586</span>
<span class="linenos"> 587</span>    <span class="n">types_map</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 588</span>        <span class="s2">&quot;css&quot;</span><span class="p">:</span> <span class="s2">&quot;text/css&quot;</span><span class="p">,</span>
<span class="linenos"> 589</span>        <span class="s2">&quot;gif&quot;</span><span class="p">:</span> <span class="s2">&quot;image/gif&quot;</span><span class="p">,</span>
<span class="linenos"> 590</span>        <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span>
<span class="linenos"> 591</span>        <span class="s2">&quot;jpg&quot;</span><span class="p">:</span> <span class="s2">&quot;image/jpeg&quot;</span><span class="p">,</span>
<span class="linenos"> 592</span>        <span class="s2">&quot;js&quot;</span><span class="p">:</span> <span class="s2">&quot;application/javascript&quot;</span><span class="p">,</span>
<span class="linenos"> 593</span>        <span class="s2">&quot;json&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="linenos"> 594</span>        <span class="s2">&quot;png&quot;</span><span class="p">:</span> <span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
<span class="linenos"> 595</span>        <span class="s2">&quot;txt&quot;</span><span class="p">:</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">,</span>
<span class="linenos"> 596</span>        <span class="s2">&quot;svg&quot;</span><span class="p">:</span> <span class="s2">&quot;image/svg+xml&quot;</span><span class="p">,</span>
<span class="linenos"> 597</span>    <span class="p">}</span>
<span class="linenos"> 598</span>
<span class="linenos"> 599</span>    <span class="n">send_file_buffer_size</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="linenos"> 600</span>
<span class="linenos"> 601</span>    <span class="c1">#: The content type to use for responses that do not explicitly define a</span>
<span class="linenos"> 602</span>    <span class="c1">#: ``Content-Type`` header.</span>
<span class="linenos"> 603</span>    <span class="n">default_content_type</span> <span class="o">=</span> <span class="s2">&quot;text/plain&quot;</span>
<span class="linenos"> 604</span>
<span class="linenos"> 605</span>    <span class="c1">#: The default cache control max age used by :meth:`send_file`. A value</span>
<span class="linenos"> 606</span>    <span class="c1">#: of ``None`` means that no ``Cache-Control`` header is added.</span>
<span class="linenos"> 607</span>    <span class="n">default_send_file_max_age</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 608</span>
<span class="linenos"> 609</span>    <span class="c1">#: Special response used to signal that a response does not need to be</span>
<span class="linenos"> 610</span>    <span class="c1">#: written to the client. Used to exit WebSocket connections cleanly.</span>
<span class="linenos"> 611</span>    <span class="n">already_handled</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 612</span>
<span class="linenos"> 613</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 614</span>        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<span class="linenos"> 615</span>            <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 616</span>            <span class="n">status_code</span> <span class="o">=</span> <span class="mi">204</span>
<span class="linenos"> 617</span>        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
<span class="linenos"> 618</span>        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">NoCaseDict</span><span class="p">(</span><span class="n">headers</span> <span class="ow">or</span> <span class="p">{})</span>
<span class="linenos"> 619</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
<span class="linenos"> 620</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
<span class="linenos"> 621</span>            <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 622</span>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;application/json; charset=UTF-8&quot;</span>
<span class="linenos"> 623</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 624</span>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="linenos"> 625</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 626</span>            <span class="c1"># this applies to bytes, file-like objects or generators</span>
<span class="linenos"> 627</span>            <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
<span class="linenos"> 628</span>        <span class="bp">self</span><span class="o">.</span><span class="n">is_head</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos"> 629</span>
<span class="linenos"> 630</span>    <span class="k">def</span><span class="w"> </span><span class="nf">set_cookie</span><span class="p">(</span>
<span class="linenos"> 631</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos"> 632</span>        <span class="n">cookie</span><span class="p">,</span>
<span class="linenos"> 633</span>        <span class="n">value</span><span class="p">,</span>
<span class="linenos"> 634</span>        <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 635</span>        <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 636</span>        <span class="n">expires</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 637</span>        <span class="n">max_age</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 638</span>        <span class="n">secure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 639</span>        <span class="n">http_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 640</span>        <span class="n">partitioned</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 641</span>    <span class="p">):</span>
<span class="linenos"> 642</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a cookie to the response.</span>
<span class="linenos"> 643</span>
<span class="linenos"> 644</span><span class="sd">        :param cookie: The cookie&#39;s name.</span>
<span class="linenos"> 645</span><span class="sd">        :param value: The cookie&#39;s value.</span>
<span class="linenos"> 646</span><span class="sd">        :param path: The cookie&#39;s path.</span>
<span class="linenos"> 647</span><span class="sd">        :param domain: The cookie&#39;s domain.</span>
<span class="linenos"> 648</span><span class="sd">        :param expires: The cookie expiration time, as a ``datetime`` object</span>
<span class="linenos"> 649</span><span class="sd">                        or a correctly formatted string.</span>
<span class="linenos"> 650</span><span class="sd">        :param max_age: The cookie&#39;s ``Max-Age`` value.</span>
<span class="linenos"> 651</span><span class="sd">        :param secure: The cookie&#39;s ``secure`` flag.</span>
<span class="linenos"> 652</span><span class="sd">        :param http_only: The cookie&#39;s ``HttpOnly`` flag.</span>
<span class="linenos"> 653</span><span class="sd">        :param partitioned: Whether the cookie is partitioned.</span>
<span class="linenos"> 654</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 655</span>        <span class="n">http_cookie</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{cookie}</span><span class="s2">=</span><span class="si">{value}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cookie</span><span class="o">=</span><span class="n">cookie</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
<span class="linenos"> 656</span>        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
<span class="linenos"> 657</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Path=&quot;</span> <span class="o">+</span> <span class="n">path</span>
<span class="linenos"> 658</span>        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
<span class="linenos"> 659</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Domain=&quot;</span> <span class="o">+</span> <span class="n">domain</span>
<span class="linenos"> 660</span>        <span class="k">if</span> <span class="n">expires</span><span class="p">:</span>
<span class="linenos"> 661</span>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos"> 662</span>                <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Expires=&quot;</span> <span class="o">+</span> <span class="n">expires</span>
<span class="linenos"> 663</span>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 664</span>                <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Expires=&quot;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
<span class="linenos"> 665</span>                    <span class="s2">&quot;</span><span class="si">%a</span><span class="s2">, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S GMT&quot;</span><span class="p">,</span> <span class="n">expires</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span>
<span class="linenos"> 666</span>                <span class="p">)</span>
<span class="linenos"> 667</span>        <span class="k">if</span> <span class="n">max_age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 668</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Max-Age=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_age</span><span class="p">)</span>
<span class="linenos"> 669</span>        <span class="k">if</span> <span class="n">secure</span><span class="p">:</span>
<span class="linenos"> 670</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Secure&quot;</span>
<span class="linenos"> 671</span>        <span class="k">if</span> <span class="n">http_only</span><span class="p">:</span>
<span class="linenos"> 672</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; HttpOnly&quot;</span>
<span class="linenos"> 673</span>        <span class="k">if</span> <span class="n">partitioned</span><span class="p">:</span>
<span class="linenos"> 674</span>            <span class="n">http_cookie</span> <span class="o">+=</span> <span class="s2">&quot;; Partitioned&quot;</span>
<span class="linenos"> 675</span>        <span class="k">if</span> <span class="s2">&quot;Set-Cookie&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 676</span>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Set-Cookie&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">http_cookie</span><span class="p">)</span>
<span class="linenos"> 677</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 678</span>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Set-Cookie&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">http_cookie</span><span class="p">]</span>
<span class="linenos"> 679</span>
<span class="linenos"> 680</span>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_cookie</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="linenos"> 681</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a cookie.</span>
<span class="linenos"> 682</span>
<span class="linenos"> 683</span><span class="sd">        :param cookie: The cookie&#39;s name.</span>
<span class="linenos"> 684</span><span class="sd">        :param kwargs: Any cookie opens and flags supported by</span>
<span class="linenos"> 685</span><span class="sd">                       ``set_cookie()`` except ``expires`` and ``max_age``.</span>
<span class="linenos"> 686</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 687</span>        <span class="bp">self</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
<span class="linenos"> 688</span>            <span class="n">cookie</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="s2">&quot;Thu, 01 Jan 1970 00:00:01 GMT&quot;</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="linenos"> 689</span>        <span class="p">)</span>
<span class="linenos"> 690</span>
<span class="linenos"> 691</span>    <span class="k">def</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 692</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Content-Length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 693</span>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
<span class="linenos"> 694</span>        <span class="k">if</span> <span class="s2">&quot;Content-Type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">:</span>
<span class="linenos"> 695</span>            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_content_type</span>
<span class="linenos"> 696</span>            <span class="k">if</span> <span class="s2">&quot;charset=&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]:</span>
<span class="linenos"> 697</span>                <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;; charset=UTF-8&quot;</span>
<span class="linenos"> 698</span>
<span class="linenos"> 699</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
<span class="linenos"> 700</span>        <span class="bp">self</span><span class="o">.</span><span class="n">complete</span><span class="p">()</span>
<span class="linenos"> 701</span>
<span class="linenos"> 702</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 703</span>            <span class="c1"># status code</span>
<span class="linenos"> 704</span>            <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos"> 705</span>                <span class="bp">self</span><span class="o">.</span><span class="n">reason</span>
<span class="linenos"> 706</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<span class="linenos"> 707</span>                <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;OK&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
<span class="linenos"> 708</span>            <span class="p">)</span>
<span class="linenos"> 709</span>            <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">awrite</span><span class="p">(</span>
<span class="linenos"> 710</span>                <span class="s2">&quot;HTTP/1.0 </span><span class="si">{status_code}</span><span class="s2"> </span><span class="si">{reason}</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="linenos"> 711</span>                    <span class="n">status_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span>
<span class="linenos"> 712</span>                <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="linenos"> 713</span>            <span class="p">)</span>
<span class="linenos"> 714</span>
<span class="linenos"> 715</span>            <span class="c1"># headers</span>
<span class="linenos"> 716</span>            <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos"> 717</span>                <span class="n">values</span> <span class="o">=</span> <span class="n">value</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">value</span><span class="p">]</span>
<span class="linenos"> 718</span>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
<span class="linenos"> 719</span>                    <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">awrite</span><span class="p">(</span>
<span class="linenos"> 720</span>                        <span class="s2">&quot;</span><span class="si">{header}</span><span class="s2">: </span><span class="si">{value}</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="linenos"> 721</span>                            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span>
<span class="linenos"> 722</span>                        <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="linenos"> 723</span>                    <span class="p">)</span>
<span class="linenos"> 724</span>            <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">awrite</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 725</span>
<span class="linenos"> 726</span>            <span class="c1"># body</span>
<span class="linenos"> 727</span>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_head</span><span class="p">:</span>
<span class="linenos"> 728</span>                <span class="nb">iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body_iter</span><span class="p">()</span>
<span class="linenos"> 729</span>                <span class="k">async</span> <span class="k">for</span> <span class="n">body</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">:</span>
<span class="linenos"> 730</span>                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 731</span>                        <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
<span class="linenos"> 732</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 733</span>                        <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">awrite</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 734</span>                    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 735</span>                        <span class="k">if</span> <span class="p">(</span>
<span class="linenos"> 736</span>                            <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="n">MUTED_SOCKET_ERRORS</span>
<span class="linenos"> 737</span>                            <span class="ow">or</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Connection lost&quot;</span>
<span class="linenos"> 738</span>                        <span class="p">):</span>
<span class="linenos"> 739</span>                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="s2">&quot;aclose&quot;</span><span class="p">):</span>
<span class="linenos"> 740</span>                                <span class="k">await</span> <span class="nb">iter</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
<span class="linenos"> 741</span>                        <span class="k">raise</span>
<span class="linenos"> 742</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="nb">iter</span><span class="p">,</span> <span class="s2">&quot;aclose&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no branch</span>
<span class="linenos"> 743</span>                    <span class="k">await</span> <span class="nb">iter</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
<span class="linenos"> 744</span>
<span class="linenos"> 745</span>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 746</span>            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="n">MUTED_SOCKET_ERRORS</span> <span class="ow">or</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Connection lost&quot;</span><span class="p">:</span>
<span class="linenos"> 747</span>                <span class="k">pass</span>
<span class="linenos"> 748</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 749</span>                <span class="k">raise</span>
<span class="linenos"> 750</span>
<span class="linenos"> 751</span>    <span class="k">def</span><span class="w"> </span><span class="nf">body_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 752</span>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;__anext__&quot;</span><span class="p">):</span>
<span class="linenos"> 753</span>            <span class="c1"># response body is an async generator</span>
<span class="linenos"> 754</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
<span class="linenos"> 755</span>
<span class="linenos"> 756</span>        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span>
<span class="linenos"> 757</span>
<span class="linenos"> 758</span>        <span class="k">class</span><span class="w"> </span><span class="nc">iter</span><span class="p">:</span>
<span class="linenos"> 759</span>            <span class="n">ITER_UNKNOWN</span> <span class="o">=</span> <span class="mi">0</span>
<span class="linenos"> 760</span>            <span class="n">ITER_SYNC_GEN</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 761</span>            <span class="n">ITER_FILE_OBJ</span> <span class="o">=</span> <span class="mi">2</span>
<span class="linenos"> 762</span>            <span class="n">ITER_NO_BODY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="linenos"> 763</span>
<span class="linenos"> 764</span>            <span class="k">def</span><span class="w"> </span><span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 765</span>                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
<span class="linenos"> 766</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_UNKNOWN</span>  <span class="c1"># need to determine type</span>
<span class="linenos"> 767</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 768</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_NO_BODY</span>
<span class="linenos"> 769</span>                <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 770</span>
<span class="linenos"> 771</span>            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 772</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_NO_BODY</span><span class="p">:</span>
<span class="linenos"> 773</span>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
<span class="linenos"> 774</span>                    <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
<span class="linenos"> 775</span>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_UNKNOWN</span><span class="p">:</span>
<span class="linenos"> 776</span>                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;read&quot;</span><span class="p">):</span>
<span class="linenos"> 777</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_FILE_OBJ</span>
<span class="linenos"> 778</span>                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;__next__&quot;</span><span class="p">):</span>
<span class="linenos"> 779</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_SYNC_GEN</span>
<span class="linenos"> 780</span>                        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 781</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 782</span>                        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_NO_BODY</span>
<span class="linenos"> 783</span>                        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span>
<span class="linenos"> 784</span>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_SYNC_GEN</span><span class="p">:</span>
<span class="linenos"> 785</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 786</span>                        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 787</span>                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="linenos"> 788</span>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
<span class="linenos"> 789</span>                        <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
<span class="linenos"> 790</span>                <span class="n">buf</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">send_file_buffer_size</span><span class="p">)</span>
<span class="linenos"> 791</span>                <span class="k">if</span> <span class="n">iscoroutine</span><span class="p">(</span><span class="n">buf</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 792</span>                    <span class="n">buf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">buf</span>
<span class="linenos"> 793</span>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">response</span><span class="o">.</span><span class="n">send_file_buffer_size</span><span class="p">:</span>
<span class="linenos"> 794</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ITER_NO_BODY</span>
<span class="linenos"> 795</span>                <span class="k">return</span> <span class="n">buf</span>
<span class="linenos"> 796</span>
<span class="linenos"> 797</span>            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 798</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="s2">&quot;close&quot;</span><span class="p">):</span>
<span class="linenos"> 799</span>                    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos"> 800</span>                    <span class="k">if</span> <span class="n">iscoroutine</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 801</span>                        <span class="k">await</span> <span class="n">result</span>
<span class="linenos"> 802</span>
<span class="linenos"> 803</span>        <span class="k">return</span> <span class="nb">iter</span><span class="p">()</span>
<span class="linenos"> 804</span>
<span class="linenos"> 805</span>    <span class="c1"># @classmethod</span>
<span class="linenos"> 806</span>    <span class="c1"># def redirect(cls, location, status_code=302):</span>
<span class="linenos"> 807</span>    <span class="c1">#     &quot;&quot;&quot;Return a redirect response.</span>
<span class="linenos"> 808</span>
<span class="linenos"> 809</span>    <span class="c1">#     :param location: The URL to redirect to.</span>
<span class="linenos"> 810</span>    <span class="c1">#     :param status_code: The 3xx status code to use for the redirect. The</span>
<span class="linenos"> 811</span>    <span class="c1">#                         default is 302.</span>
<span class="linenos"> 812</span>    <span class="c1">#     &quot;&quot;&quot;</span>
<span class="linenos"> 813</span>    <span class="c1">#     if &#39;\x0d&#39; in location or &#39;\x0a&#39; in location:</span>
<span class="linenos"> 814</span>    <span class="c1">#         raise ValueError(&#39;invalid redirect URL&#39;)</span>
<span class="linenos"> 815</span>    <span class="c1">#     return cls(status_code=status_code, headers={&#39;Location&#39;: location})</span>
<span class="linenos"> 816</span>
<span class="linenos"> 817</span>    <span class="c1"># @classmethod</span>
<span class="linenos"> 818</span>    <span class="c1"># def send_file(cls, filename, status_code=200, content_type=None,</span>
<span class="linenos"> 819</span>    <span class="c1">#               stream=None, max_age=None, compressed=False,</span>
<span class="linenos"> 820</span>    <span class="c1">#               file_extension=&#39;&#39;):</span>
<span class="linenos"> 821</span>    <span class="c1">#     &quot;&quot;&quot;Send file contents in a response.</span>
<span class="linenos"> 822</span>
<span class="linenos"> 823</span>    <span class="c1">#     :param filename: The filename of the file.</span>
<span class="linenos"> 824</span>    <span class="c1">#     :param status_code: The 3xx status code to use for the redirect. The</span>
<span class="linenos"> 825</span>    <span class="c1">#                         default is 302.</span>
<span class="linenos"> 826</span>    <span class="c1">#     :param content_type: The ``Content-Type`` header to use in the</span>
<span class="linenos"> 827</span>    <span class="c1">#                          response. If omitted, it is generated</span>
<span class="linenos"> 828</span>    <span class="c1">#                          automatically from the file extension of the</span>
<span class="linenos"> 829</span>    <span class="c1">#                          ``filename`` parameter.</span>
<span class="linenos"> 830</span>    <span class="c1">#     :param stream: A file-like object to read the file contents from. If</span>
<span class="linenos"> 831</span>    <span class="c1">#                    a stream is given, the ``filename`` parameter is only</span>
<span class="linenos"> 832</span>    <span class="c1">#                    used when generating the ``Content-Type`` header.</span>
<span class="linenos"> 833</span>    <span class="c1">#     :param max_age: The ``Cache-Control`` header&#39;s ``max-age`` value in</span>
<span class="linenos"> 834</span>    <span class="c1">#                     seconds. If omitted, the value of the</span>
<span class="linenos"> 835</span>    <span class="c1">#                     :attr:`Response.default_send_file_max_age` attribute is</span>
<span class="linenos"> 836</span>    <span class="c1">#                     used.</span>
<span class="linenos"> 837</span>    <span class="c1">#     :param compressed: Whether the file is compressed. If ``True``, the</span>
<span class="linenos"> 838</span>    <span class="c1">#                        ``Content-Encoding`` header is set to ``gzip``. A</span>
<span class="linenos"> 839</span>    <span class="c1">#                        string with the header value can also be passed.</span>
<span class="linenos"> 840</span>    <span class="c1">#                        Note that when using this option the file must have</span>
<span class="linenos"> 841</span>    <span class="c1">#                        been compressed beforehand. This option only sets</span>
<span class="linenos"> 842</span>    <span class="c1">#                        the header.</span>
<span class="linenos"> 843</span>    <span class="c1">#     :param file_extension: A file extension to append to the ``filename``</span>
<span class="linenos"> 844</span>    <span class="c1">#                            parameter when opening the file, including the</span>
<span class="linenos"> 845</span>    <span class="c1">#                            dot. The extension given here is not considered</span>
<span class="linenos"> 846</span>    <span class="c1">#                            when generating the ``Content-Type`` header.</span>
<span class="linenos"> 847</span>
<span class="linenos"> 848</span>    <span class="c1">#     Security note: The filename is assumed to be trusted. Never pass</span>
<span class="linenos"> 849</span>    <span class="c1">#     filenames provided by the user without validating and sanitizing them</span>
<span class="linenos"> 850</span>    <span class="c1">#     first.</span>
<span class="linenos"> 851</span>    <span class="c1">#     &quot;&quot;&quot;</span>
<span class="linenos"> 852</span>    <span class="c1">#     if content_type is None:</span>
<span class="linenos"> 853</span>    <span class="c1">#         if compressed and filename.endswith(&#39;.gz&#39;):</span>
<span class="linenos"> 854</span>    <span class="c1">#             ext = filename[:-3].split(&#39;.&#39;)[-1]</span>
<span class="linenos"> 855</span>    <span class="c1">#         else:</span>
<span class="linenos"> 856</span>    <span class="c1">#             ext = filename.split(&#39;.&#39;)[-1]</span>
<span class="linenos"> 857</span>    <span class="c1">#         if ext in Response.types_map:</span>
<span class="linenos"> 858</span>    <span class="c1">#             content_type = Response.types_map[ext]</span>
<span class="linenos"> 859</span>    <span class="c1">#         else:</span>
<span class="linenos"> 860</span>    <span class="c1">#             content_type = &#39;application/octet-stream&#39;</span>
<span class="linenos"> 861</span>    <span class="c1">#     headers = {&#39;Content-Type&#39;: content_type}</span>
<span class="linenos"> 862</span>
<span class="linenos"> 863</span>    <span class="c1">#     if max_age is None:</span>
<span class="linenos"> 864</span>    <span class="c1">#         max_age = cls.default_send_file_max_age</span>
<span class="linenos"> 865</span>    <span class="c1">#     if max_age is not None:</span>
<span class="linenos"> 866</span>    <span class="c1">#         headers[&#39;Cache-Control&#39;] = &#39;max-age={}&#39;.format(max_age)</span>
<span class="linenos"> 867</span>
<span class="linenos"> 868</span>    <span class="c1">#     if compressed:</span>
<span class="linenos"> 869</span>    <span class="c1">#         headers[&#39;Content-Encoding&#39;] = compressed \</span>
<span class="linenos"> 870</span>    <span class="c1">#             if isinstance(compressed, str) else &#39;gzip&#39;</span>
<span class="linenos"> 871</span>
<span class="linenos"> 872</span>    <span class="c1">#     f = stream or open(filename + file_extension, &#39;rb&#39;)</span>
<span class="linenos"> 873</span>    <span class="c1">#     return cls(body=f, status_code=status_code, headers=headers)</span>
<span class="linenos"> 874</span>
<span class="linenos"> 875</span>
<span class="linenos"> 876</span><span class="k">class</span><span class="w"> </span><span class="nc">URLPattern</span><span class="p">:</span>
<span class="linenos"> 877</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;A class that represents the URL pattern for a route.</span>
<span class="linenos"> 878</span>
<span class="linenos"> 879</span><span class="sd">    :param url_pattern: The route URL pattern, which can include static and</span>
<span class="linenos"> 880</span><span class="sd">                        dynamic path segments. Dynamic segments are enclosed in</span>
<span class="linenos"> 881</span><span class="sd">                        ``&lt;`` and ``&gt;``. The type of the segment can be given</span>
<span class="linenos"> 882</span><span class="sd">                        as a prefix, separated from the name with a colon.</span>
<span class="linenos"> 883</span><span class="sd">                        Supported types are ``string`` (the default),</span>
<span class="linenos"> 884</span><span class="sd">                        ``int`` and ``path``. Custom types can be registered</span>
<span class="linenos"> 885</span><span class="sd">                        using the :meth:`URLPattern.register_type` method.</span>
<span class="linenos"> 886</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 887</span>
<span class="linenos"> 888</span>    <span class="n">segment_patterns</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 889</span>        <span class="s2">&quot;string&quot;</span><span class="p">:</span> <span class="s2">&quot;/([^/]+)&quot;</span><span class="p">,</span>
<span class="linenos"> 890</span>        <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="s2">&quot;/(-?</span><span class="se">\\</span><span class="s2">d+)&quot;</span><span class="p">,</span>
<span class="linenos"> 891</span>        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/(.+)&quot;</span><span class="p">,</span>
<span class="linenos"> 892</span>    <span class="p">}</span>
<span class="linenos"> 893</span>    <span class="n">segment_parsers</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 894</span>        <span class="s2">&quot;int&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
<span class="linenos"> 895</span>    <span class="p">}</span>
<span class="linenos"> 896</span>
<span class="linenos"> 897</span>    <span class="nd">@classmethod</span>
<span class="linenos"> 898</span>    <span class="k">def</span><span class="w"> </span><span class="nf">register_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;[^/]+&quot;</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 899</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a new URL segment type.</span>
<span class="linenos"> 900</span>
<span class="linenos"> 901</span><span class="sd">        :param type_name: The name of the segment type to register.</span>
<span class="linenos"> 902</span><span class="sd">        :param pattern: The regular expression pattern to use when matching</span>
<span class="linenos"> 903</span><span class="sd">                        this segment type. If not given, a default matcher for</span>
<span class="linenos"> 904</span><span class="sd">                        a single path segment is used.</span>
<span class="linenos"> 905</span><span class="sd">        :param parser: A callable that will be used to parse and transform the</span>
<span class="linenos"> 906</span><span class="sd">                       value of the segment. If omitted, the value is returned</span>
<span class="linenos"> 907</span><span class="sd">                       as a string.</span>
<span class="linenos"> 908</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 909</span>        <span class="bp">cls</span><span class="o">.</span><span class="n">segment_patterns</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;/(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="linenos"> 910</span>        <span class="bp">cls</span><span class="o">.</span><span class="n">segment_parsers</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span>
<span class="linenos"> 911</span>
<span class="linenos"> 912</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos"> 913</span>        <span class="bp">self</span><span class="o">.</span><span class="n">url_pattern</span> <span class="o">=</span> <span class="n">url_pattern</span>
<span class="linenos"> 914</span>        <span class="bp">self</span><span class="o">.</span><span class="n">segments</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 915</span>        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 916</span>
<span class="linenos"> 917</span>    <span class="k">def</span><span class="w"> </span><span class="nf">compile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 918</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a regular expression for the URL pattern.</span>
<span class="linenos"> 919</span>
<span class="linenos"> 920</span><span class="sd">        This method is automatically invoked the first time the URL pattern is</span>
<span class="linenos"> 921</span><span class="sd">        matched against a path.</span>
<span class="linenos"> 922</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 923</span>        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 924</span>        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_pattern</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
<span class="linenos"> 925</span>            <span class="k">if</span> <span class="n">segment</span> <span class="ow">and</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span>
<span class="linenos"> 926</span>                <span class="k">if</span> <span class="n">segment</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
<span class="linenos"> 927</span>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid URL pattern&quot;</span><span class="p">)</span>
<span class="linenos"> 928</span>                <span class="n">segment</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 929</span>                <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">segment</span><span class="p">:</span>
<span class="linenos"> 930</span>                    <span class="n">type_</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 931</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 932</span>                    <span class="n">type_</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
<span class="linenos"> 933</span>                    <span class="n">name</span> <span class="o">=</span> <span class="n">segment</span>
<span class="linenos"> 934</span>                <span class="n">parser</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 935</span>                <span class="k">if</span> <span class="n">type_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;re:&quot;</span><span class="p">):</span>
<span class="linenos"> 936</span>                    <span class="n">pattern</span> <span class="o">+=</span> <span class="s2">&quot;/(</span><span class="si">{pattern}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">type_</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
<span class="linenos"> 937</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 938</span>                    <span class="k">if</span> <span class="n">type_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_patterns</span><span class="p">:</span>
<span class="linenos"> 939</span>                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid URL segment type&quot;</span><span class="p">)</span>
<span class="linenos"> 940</span>                    <span class="n">pattern</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_patterns</span><span class="p">[</span><span class="n">type_</span><span class="p">]</span>
<span class="linenos"> 941</span>                    <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_parsers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">type_</span><span class="p">)</span>
<span class="linenos"> 942</span>                <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="n">parser</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">type_</span><span class="p">})</span>
<span class="linenos"> 943</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 944</span>                <span class="n">pattern</span> <span class="o">+=</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">segment</span>
<span class="linenos"> 945</span>                <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
<span class="linenos"> 946</span>        <span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s2">&quot;$&quot;</span><span class="p">)</span>
<span class="linenos"> 947</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span>
<span class="linenos"> 948</span>
<span class="linenos"> 949</span>    <span class="k">def</span><span class="w"> </span><span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="linenos"> 950</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Match a path against the URL pattern.</span>
<span class="linenos"> 951</span>
<span class="linenos"> 952</span><span class="sd">        Returns a dictionary with the values of all dynamic path segments if a</span>
<span class="linenos"> 953</span><span class="sd">        matche is found, or ``None`` if the path does not match this pattern.</span>
<span class="linenos"> 954</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos"> 955</span>        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 956</span>        <span class="n">g</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">regex</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">compile</span><span class="p">())</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="linenos"> 957</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="p">:</span>
<span class="linenos"> 958</span>            <span class="k">return</span>
<span class="linenos"> 959</span>        <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="linenos"> 960</span>        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
<span class="linenos"> 961</span>            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">segment</span><span class="p">:</span>
<span class="linenos"> 962</span>                <span class="k">continue</span>
<span class="linenos"> 963</span>            <span class="n">arg</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="linenos"> 964</span>            <span class="k">if</span> <span class="n">segment</span><span class="p">[</span><span class="s2">&quot;parser&quot;</span><span class="p">]:</span>
<span class="linenos"> 965</span>                <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segment_parsers</span><span class="p">[</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]](</span><span class="n">arg</span><span class="p">)</span>
<span class="linenos"> 966</span>                <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 967</span>                    <span class="k">return</span>
<span class="linenos"> 968</span>            <span class="n">args</span><span class="p">[</span><span class="n">segment</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">arg</span>
<span class="linenos"> 969</span>            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="linenos"> 970</span>        <span class="k">return</span> <span class="n">args</span>
<span class="linenos"> 971</span>
<span class="linenos"> 972</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 973</span>        <span class="k">return</span> <span class="s2">&quot;URLPattern: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_pattern</span><span class="p">)</span>
<span class="linenos"> 974</span>
<span class="linenos"> 975</span>
<span class="linenos"> 976</span><span class="k">class</span><span class="w"> </span><span class="nc">HTTPException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="linenos"> 977</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 978</span>        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
<span class="linenos"> 979</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; error&quot;</span>
<span class="linenos"> 980</span>
<span class="linenos"> 981</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos"> 982</span>        <span class="k">return</span> <span class="s2">&quot;HTTPException: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="linenos"> 983</span>
<span class="linenos"> 984</span>
<span class="linenos"> 985</span><span class="k">class</span><span class="w"> </span><span class="nc">Microdot</span><span class="p">:</span>
<span class="linenos"> 986</span><span class="w">    </span><span class="sd">&quot;&quot;&quot;An HTTP application class.</span>
<span class="linenos"> 987</span>
<span class="linenos"> 988</span><span class="sd">    This class implements an HTTP application instance and is heavily</span>
<span class="linenos"> 989</span><span class="sd">    influenced by the ``Flask`` class of the Flask framework. It is typically</span>
<span class="linenos"> 990</span><span class="sd">    declared near the start of the main application script.</span>
<span class="linenos"> 991</span>
<span class="linenos"> 992</span><span class="sd">    Example::</span>
<span class="linenos"> 993</span>
<span class="linenos"> 994</span><span class="sd">        from microdot import Microdot</span>
<span class="linenos"> 995</span>
<span class="linenos"> 996</span><span class="sd">        app = Microdot()</span>
<span class="linenos"> 997</span><span class="sd">    &quot;&quot;&quot;</span>
<span class="linenos"> 998</span>
<span class="linenos"> 999</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1000</span>        <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1001</span>        <span class="bp">self</span><span class="o">.</span><span class="n">before_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1002</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1003</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_error_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1004</span>        <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1005</span>        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_requested</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1006</span>        <span class="bp">self</span><span class="o">.</span><span class="n">options_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_options_handler</span>
<span class="linenos">1007</span>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1008</span>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1009</span>
<span class="linenos">1010</span>    <span class="k">def</span><span class="w"> </span><span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1011</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a request handler</span>
<span class="linenos">1012</span><span class="sd">        for a given URL.</span>
<span class="linenos">1013</span>
<span class="linenos">1014</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1015</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1016</span><span class="sd">        :param methods: The list of HTTP methods to be handled by the</span>
<span class="linenos">1017</span><span class="sd">                        decorated function. If omitted, only ``GET`` requests</span>
<span class="linenos">1018</span><span class="sd">                        are handled.</span>
<span class="linenos">1019</span>
<span class="linenos">1020</span><span class="sd">        The URL pattern can be a static path (for example, ``/users`` or</span>
<span class="linenos">1021</span><span class="sd">        ``/api/invoices/search``) or a path with dynamic components enclosed</span>
<span class="linenos">1022</span><span class="sd">        in ``&lt;`` and ``&gt;`` (for example, ``/users/&lt;id&gt;`` or</span>
<span class="linenos">1023</span><span class="sd">        ``/invoices/&lt;number&gt;/products``). Dynamic path components can also</span>
<span class="linenos">1024</span><span class="sd">        include a type prefix, separated from the name with a colon (for</span>
<span class="linenos">1025</span><span class="sd">        example, ``/users/&lt;int:id&gt;``). The type can be ``string`` (the</span>
<span class="linenos">1026</span><span class="sd">        default), ``int``, ``path`` or ``re:[regular-expression]``.</span>
<span class="linenos">1027</span>
<span class="linenos">1028</span><span class="sd">        The first argument of the decorated function must be</span>
<span class="linenos">1029</span><span class="sd">        the request object. Any path arguments that are specified in the URL</span>
<span class="linenos">1030</span><span class="sd">        pattern are passed as keyword arguments. The return value of the</span>
<span class="linenos">1031</span><span class="sd">        function must be a :class:`Response` instance, or the arguments to</span>
<span class="linenos">1032</span><span class="sd">        be passed to this class.</span>
<span class="linenos">1033</span>
<span class="linenos">1034</span><span class="sd">        Example::</span>
<span class="linenos">1035</span>
<span class="linenos">1036</span><span class="sd">            @app.route(&#39;/&#39;)</span>
<span class="linenos">1037</span><span class="sd">            def index(request):</span>
<span class="linenos">1038</span><span class="sd">                return &#39;Hello, world!&#39;</span>
<span class="linenos">1039</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1040</span>
<span class="linenos">1041</span>        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="linenos">1042</span>            <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">1043</span>                <span class="p">(</span>
<span class="linenos">1044</span>                    <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">methods</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])],</span>
<span class="linenos">1045</span>                    <span class="n">URLPattern</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">),</span>
<span class="linenos">1046</span>                    <span class="n">f</span><span class="p">,</span>
<span class="linenos">1047</span>                    <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1048</span>                    <span class="kc">None</span><span class="p">,</span>
<span class="linenos">1049</span>                <span class="p">)</span>
<span class="linenos">1050</span>            <span class="p">)</span>
<span class="linenos">1051</span>            <span class="k">return</span> <span class="n">f</span>
<span class="linenos">1052</span>
<span class="linenos">1053</span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="linenos">1054</span>
<span class="linenos">1055</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos">1056</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a ``GET`` request</span>
<span class="linenos">1057</span><span class="sd">        handler for a given URL.</span>
<span class="linenos">1058</span>
<span class="linenos">1059</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1060</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1061</span>
<span class="linenos">1062</span><span class="sd">        This decorator can be used as an alias to the ``route`` decorator with</span>
<span class="linenos">1063</span><span class="sd">        ``methods=[&#39;GET&#39;]``.</span>
<span class="linenos">1064</span>
<span class="linenos">1065</span><span class="sd">        Example::</span>
<span class="linenos">1066</span>
<span class="linenos">1067</span><span class="sd">            @app.get(&#39;/users/&lt;int:id&gt;&#39;)</span>
<span class="linenos">1068</span><span class="sd">            def get_user(request, id):</span>
<span class="linenos">1069</span><span class="sd">                # ...</span>
<span class="linenos">1070</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1071</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="linenos">1072</span>
<span class="linenos">1073</span>    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos">1074</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a ``POST`` request</span>
<span class="linenos">1075</span><span class="sd">        handler for a given URL.</span>
<span class="linenos">1076</span>
<span class="linenos">1077</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1078</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1079</span>
<span class="linenos">1080</span><span class="sd">        This decorator can be used as an alias to the``route`` decorator with</span>
<span class="linenos">1081</span><span class="sd">        ``methods=[&#39;POST&#39;]``.</span>
<span class="linenos">1082</span>
<span class="linenos">1083</span><span class="sd">        Example::</span>
<span class="linenos">1084</span>
<span class="linenos">1085</span><span class="sd">            @app.post(&#39;/users&#39;)</span>
<span class="linenos">1086</span><span class="sd">            def create_user(request):</span>
<span class="linenos">1087</span><span class="sd">                # ...</span>
<span class="linenos">1088</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1089</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="linenos">1090</span>
<span class="linenos">1091</span>    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos">1092</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a ``PUT`` request</span>
<span class="linenos">1093</span><span class="sd">        handler for a given URL.</span>
<span class="linenos">1094</span>
<span class="linenos">1095</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1096</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1097</span>
<span class="linenos">1098</span><span class="sd">        This decorator can be used as an alias to the ``route`` decorator with</span>
<span class="linenos">1099</span><span class="sd">        ``methods=[&#39;PUT&#39;]``.</span>
<span class="linenos">1100</span>
<span class="linenos">1101</span><span class="sd">        Example::</span>
<span class="linenos">1102</span>
<span class="linenos">1103</span><span class="sd">            @app.put(&#39;/users/&lt;int:id&gt;&#39;)</span>
<span class="linenos">1104</span><span class="sd">            def edit_user(request, id):</span>
<span class="linenos">1105</span><span class="sd">                # ...</span>
<span class="linenos">1106</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1107</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="linenos">1108</span>
<span class="linenos">1109</span>    <span class="k">def</span><span class="w"> </span><span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos">1110</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a ``PATCH`` request</span>
<span class="linenos">1111</span><span class="sd">        handler for a given URL.</span>
<span class="linenos">1112</span>
<span class="linenos">1113</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1114</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1115</span>
<span class="linenos">1116</span><span class="sd">        This decorator can be used as an alias to the ``route`` decorator with</span>
<span class="linenos">1117</span><span class="sd">        ``methods=[&#39;PATCH&#39;]``.</span>
<span class="linenos">1118</span>
<span class="linenos">1119</span><span class="sd">        Example::</span>
<span class="linenos">1120</span>
<span class="linenos">1121</span><span class="sd">            @app.patch(&#39;/users/&lt;int:id&gt;&#39;)</span>
<span class="linenos">1122</span><span class="sd">            def edit_user(request, id):</span>
<span class="linenos">1123</span><span class="sd">                # ...</span>
<span class="linenos">1124</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1125</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PATCH&quot;</span><span class="p">])</span>
<span class="linenos">1126</span>
<span class="linenos">1127</span>    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url_pattern</span><span class="p">):</span>
<span class="linenos">1128</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator that is used to register a function as a ``DELETE``</span>
<span class="linenos">1129</span><span class="sd">        request handler for a given URL.</span>
<span class="linenos">1130</span>
<span class="linenos">1131</span><span class="sd">        :param url_pattern: The URL pattern that will be compared against</span>
<span class="linenos">1132</span><span class="sd">                            incoming requests.</span>
<span class="linenos">1133</span>
<span class="linenos">1134</span><span class="sd">        This decorator can be used as an alias to the ``route`` decorator with</span>
<span class="linenos">1135</span><span class="sd">        ``methods=[&#39;DELETE&#39;]``.</span>
<span class="linenos">1136</span>
<span class="linenos">1137</span><span class="sd">        Example::</span>
<span class="linenos">1138</span>
<span class="linenos">1139</span><span class="sd">            @app.delete(&#39;/users/&lt;int:id&gt;&#39;)</span>
<span class="linenos">1140</span><span class="sd">            def delete_user(request, id):</span>
<span class="linenos">1141</span><span class="sd">                # ...</span>
<span class="linenos">1142</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1143</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;DELETE&quot;</span><span class="p">])</span>
<span class="linenos">1144</span>
<span class="linenos">1145</span>    <span class="k">def</span><span class="w"> </span><span class="nf">before_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="linenos">1146</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a function to run before each request is</span>
<span class="linenos">1147</span><span class="sd">        handled. The decorated function must take a single argument, the</span>
<span class="linenos">1148</span><span class="sd">        request object.</span>
<span class="linenos">1149</span>
<span class="linenos">1150</span><span class="sd">        Example::</span>
<span class="linenos">1151</span>
<span class="linenos">1152</span><span class="sd">            @app.before_request</span>
<span class="linenos">1153</span><span class="sd">            def func(request):</span>
<span class="linenos">1154</span><span class="sd">                # ...</span>
<span class="linenos">1155</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1156</span>        <span class="bp">self</span><span class="o">.</span><span class="n">before_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">1157</span>        <span class="k">return</span> <span class="n">f</span>
<span class="linenos">1158</span>
<span class="linenos">1159</span>    <span class="k">def</span><span class="w"> </span><span class="nf">after_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="linenos">1160</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a function to run after each request is</span>
<span class="linenos">1161</span><span class="sd">        handled. The decorated function must take two arguments, the request</span>
<span class="linenos">1162</span><span class="sd">        and response objects. The return value of the function must be an</span>
<span class="linenos">1163</span><span class="sd">        updated response object.</span>
<span class="linenos">1164</span>
<span class="linenos">1165</span><span class="sd">        Example::</span>
<span class="linenos">1166</span>
<span class="linenos">1167</span><span class="sd">            @app.after_request</span>
<span class="linenos">1168</span><span class="sd">            def func(request, response):</span>
<span class="linenos">1169</span><span class="sd">                # ...</span>
<span class="linenos">1170</span><span class="sd">                return response</span>
<span class="linenos">1171</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1172</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">1173</span>        <span class="k">return</span> <span class="n">f</span>
<span class="linenos">1174</span>
<span class="linenos">1175</span>    <span class="k">def</span><span class="w"> </span><span class="nf">after_error_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="linenos">1176</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a function to run after an error response is</span>
<span class="linenos">1177</span><span class="sd">        generated. The decorated function must take two arguments, the request</span>
<span class="linenos">1178</span><span class="sd">        and response objects. The return value of the function must be an</span>
<span class="linenos">1179</span><span class="sd">        updated response object. The handler is invoked for error responses</span>
<span class="linenos">1180</span><span class="sd">        generated by Microdot, as well as those returned by application-defined</span>
<span class="linenos">1181</span><span class="sd">        error handlers.</span>
<span class="linenos">1182</span>
<span class="linenos">1183</span><span class="sd">        Example::</span>
<span class="linenos">1184</span>
<span class="linenos">1185</span><span class="sd">            @app.after_error_request</span>
<span class="linenos">1186</span><span class="sd">            def func(request, response):</span>
<span class="linenos">1187</span><span class="sd">                # ...</span>
<span class="linenos">1188</span><span class="sd">                return response</span>
<span class="linenos">1189</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1190</span>        <span class="bp">self</span><span class="o">.</span><span class="n">after_error_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">1191</span>        <span class="k">return</span> <span class="n">f</span>
<span class="linenos">1192</span>
<span class="linenos">1193</span>    <span class="k">def</span><span class="w"> </span><span class="nf">errorhandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_code_or_exception_class</span><span class="p">):</span>
<span class="linenos">1194</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Decorator to register a function as an error handler. Error handler</span>
<span class="linenos">1195</span><span class="sd">        functions for numeric HTTP status codes must accept a single argument,</span>
<span class="linenos">1196</span><span class="sd">        the request object. Error handler functions for Python exceptions</span>
<span class="linenos">1197</span><span class="sd">        must accept two arguments, the request object and the exception</span>
<span class="linenos">1198</span><span class="sd">        object.</span>
<span class="linenos">1199</span>
<span class="linenos">1200</span><span class="sd">        :param status_code_or_exception_class: The numeric HTTP status code or</span>
<span class="linenos">1201</span><span class="sd">                                               Python exception class to</span>
<span class="linenos">1202</span><span class="sd">                                               handle.</span>
<span class="linenos">1203</span>
<span class="linenos">1204</span><span class="sd">        Examples::</span>
<span class="linenos">1205</span>
<span class="linenos">1206</span><span class="sd">            @app.errorhandler(404)</span>
<span class="linenos">1207</span><span class="sd">            def not_found(request):</span>
<span class="linenos">1208</span><span class="sd">                return &#39;Not found&#39;</span>
<span class="linenos">1209</span>
<span class="linenos">1210</span><span class="sd">            @app.errorhandler(RuntimeError)</span>
<span class="linenos">1211</span><span class="sd">            def runtime_error(request, exception):</span>
<span class="linenos">1212</span><span class="sd">                return &#39;Runtime error&#39;</span>
<span class="linenos">1213</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1214</span>
<span class="linenos">1215</span>        <span class="k">def</span><span class="w"> </span><span class="nf">decorated</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="linenos">1216</span>            <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">status_code_or_exception_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
<span class="linenos">1217</span>            <span class="k">return</span> <span class="n">f</span>
<span class="linenos">1218</span>
<span class="linenos">1219</span>        <span class="k">return</span> <span class="n">decorated</span>
<span class="linenos">1220</span>
<span class="linenos">1221</span>    <span class="k">def</span><span class="w"> </span><span class="nf">mount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subapp</span><span class="p">,</span> <span class="n">url_prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos">1222</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Mount a sub-application, optionally under the given URL prefix.</span>
<span class="linenos">1223</span>
<span class="linenos">1224</span><span class="sd">        :param subapp: The sub-application to mount.</span>
<span class="linenos">1225</span><span class="sd">        :param url_prefix: The URL prefix to mount the application under.</span>
<span class="linenos">1226</span><span class="sd">        :param local: When set to ``True``, the before, after and error request</span>
<span class="linenos">1227</span><span class="sd">                      handlers only apply to endpoints defined in the</span>
<span class="linenos">1228</span><span class="sd">                      sub-application. When ``False``, they apply to the entire</span>
<span class="linenos">1229</span><span class="sd">                      application. The default is ``False``.</span>
<span class="linenos">1230</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1231</span>        <span class="k">for</span> <span class="n">methods</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">_prefix</span><span class="p">,</span> <span class="n">_subapp</span> <span class="ow">in</span> <span class="n">subapp</span><span class="o">.</span><span class="n">url_map</span><span class="p">:</span>
<span class="linenos">1232</span>            <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="linenos">1233</span>                <span class="p">(</span>
<span class="linenos">1234</span>                    <span class="n">methods</span><span class="p">,</span>
<span class="linenos">1235</span>                    <span class="n">URLPattern</span><span class="p">(</span><span class="n">url_prefix</span> <span class="o">+</span> <span class="n">pattern</span><span class="o">.</span><span class="n">url_pattern</span><span class="p">),</span>
<span class="linenos">1236</span>                    <span class="n">handler</span><span class="p">,</span>
<span class="linenos">1237</span>                    <span class="n">url_prefix</span> <span class="o">+</span> <span class="n">_prefix</span><span class="p">,</span>
<span class="linenos">1238</span>                    <span class="n">_subapp</span> <span class="ow">or</span> <span class="n">subapp</span><span class="p">,</span>
<span class="linenos">1239</span>                <span class="p">)</span>
<span class="linenos">1240</span>            <span class="p">)</span>
<span class="linenos">1241</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">local</span><span class="p">:</span>
<span class="linenos">1242</span>            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">subapp</span><span class="o">.</span><span class="n">before_request_handlers</span><span class="p">:</span>
<span class="linenos">1243</span>                <span class="bp">self</span><span class="o">.</span><span class="n">before_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="linenos">1244</span>            <span class="n">subapp</span><span class="o">.</span><span class="n">before_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1245</span>            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">subapp</span><span class="o">.</span><span class="n">after_request_handlers</span><span class="p">:</span>
<span class="linenos">1246</span>                <span class="bp">self</span><span class="o">.</span><span class="n">after_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="linenos">1247</span>            <span class="n">subapp</span><span class="o">.</span><span class="n">after_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1248</span>            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">subapp</span><span class="o">.</span><span class="n">after_error_request_handlers</span><span class="p">:</span>
<span class="linenos">1249</span>                <span class="bp">self</span><span class="o">.</span><span class="n">after_error_request_handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
<span class="linenos">1250</span>            <span class="n">subapp</span><span class="o">.</span><span class="n">after_error_request_handlers</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1251</span>            <span class="k">for</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<span class="linenos">1252</span>                <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">status_code</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
<span class="linenos">1253</span>            <span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos">1254</span>
<span class="linenos">1255</span>    <span class="nd">@staticmethod</span>
<span class="linenos">1256</span>    <span class="k">def</span><span class="w"> </span><span class="nf">abort</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1257</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Abort the current request and return an error response with the</span>
<span class="linenos">1258</span><span class="sd">        given status code.</span>
<span class="linenos">1259</span>
<span class="linenos">1260</span><span class="sd">        :param status_code: The numeric status code of the response.</span>
<span class="linenos">1261</span><span class="sd">        :param reason: The reason for the response, which is included in the</span>
<span class="linenos">1262</span><span class="sd">                       response body.</span>
<span class="linenos">1263</span>
<span class="linenos">1264</span><span class="sd">        Example::</span>
<span class="linenos">1265</span>
<span class="linenos">1266</span><span class="sd">            from microdot import abort</span>
<span class="linenos">1267</span>
<span class="linenos">1268</span><span class="sd">            @app.route(&#39;/users/&lt;int:id&gt;&#39;)</span>
<span class="linenos">1269</span><span class="sd">            def get_user(id):</span>
<span class="linenos">1270</span><span class="sd">                user = get_user_by_id(id)</span>
<span class="linenos">1271</span><span class="sd">                if user is None:</span>
<span class="linenos">1272</span><span class="sd">                    abort(404)</span>
<span class="linenos">1273</span><span class="sd">                return user.to_dict()</span>
<span class="linenos">1274</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1275</span>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
<span class="linenos">1276</span>
<span class="linenos">1277</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">60000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1278</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the Microdot web server as a coroutine. This coroutine does</span>
<span class="linenos">1279</span><span class="sd">        not normally return, as the server enters an endless listening loop.</span>
<span class="linenos">1280</span><span class="sd">        The :func:`shutdown` function provides a method for terminating the</span>
<span class="linenos">1281</span><span class="sd">        server gracefully.</span>
<span class="linenos">1282</span>
<span class="linenos">1283</span><span class="sd">        :param host: The hostname or IP address of the network interface that</span>
<span class="linenos">1284</span><span class="sd">                     will be listening for requests. A value of ``&#39;0.0.0.0&#39;``</span>
<span class="linenos">1285</span><span class="sd">                     (the default) indicates that the server should listen for</span>
<span class="linenos">1286</span><span class="sd">                     requests on all the available interfaces, and a value of</span>
<span class="linenos">1287</span><span class="sd">                     ``127.0.0.1`` indicates that the server should listen</span>
<span class="linenos">1288</span><span class="sd">                     for requests only on the internal networking interface of</span>
<span class="linenos">1289</span><span class="sd">                     the host.</span>
<span class="linenos">1290</span><span class="sd">        :param port: The port number to listen for requests. The default is</span>
<span class="linenos">1291</span><span class="sd">                     port 5000.</span>
<span class="linenos">1292</span><span class="sd">        :param debug: If ``True``, the server logs debugging information. The</span>
<span class="linenos">1293</span><span class="sd">                      default is ``False``.</span>
<span class="linenos">1294</span><span class="sd">        :param ssl: An ``SSLContext`` instance or ``None`` if the server should</span>
<span class="linenos">1295</span><span class="sd">                    not use TLS. The default is ``None``.</span>
<span class="linenos">1296</span>
<span class="linenos">1297</span><span class="sd">        This method is a coroutine.</span>
<span class="linenos">1298</span>
<span class="linenos">1299</span><span class="sd">        Example::</span>
<span class="linenos">1300</span>
<span class="linenos">1301</span><span class="sd">            import asyncio</span>
<span class="linenos">1302</span><span class="sd">            from microdot import Microdot</span>
<span class="linenos">1303</span>
<span class="linenos">1304</span><span class="sd">            app = Microdot()</span>
<span class="linenos">1305</span>
<span class="linenos">1306</span><span class="sd">            @app.route(&#39;/&#39;)</span>
<span class="linenos">1307</span><span class="sd">            async def index(request):</span>
<span class="linenos">1308</span><span class="sd">                return &#39;Hello, world!&#39;</span>
<span class="linenos">1309</span>
<span class="linenos">1310</span><span class="sd">            async def main():</span>
<span class="linenos">1311</span><span class="sd">                await app.start_server(debug=True)</span>
<span class="linenos">1312</span>
<span class="linenos">1313</span><span class="sd">            asyncio.run(main())</span>
<span class="linenos">1314</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1315</span>        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
<span class="linenos">1316</span>
<span class="linenos">1317</span>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">serve</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
<span class="linenos">1318</span>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="s2">&quot;awrite&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1319</span>                <span class="c1"># CPython provides the awrite and aclose methods in 3.8+</span>
<span class="linenos">1320</span>                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">awrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="linenos">1321</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">1322</span>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<span class="linenos">1323</span>
<span class="linenos">1324</span>                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">aclose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1325</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">1326</span>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
<span class="linenos">1327</span>
<span class="linenos">1328</span>                <span class="kn">from</span><span class="w"> </span><span class="nn">types</span><span class="w"> </span><span class="kn">import</span> <span class="n">MethodType</span>
<span class="linenos">1329</span>
<span class="linenos">1330</span>                <span class="n">writer</span><span class="o">.</span><span class="n">awrite</span> <span class="o">=</span> <span class="n">MethodType</span><span class="p">(</span><span class="n">awrite</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
<span class="linenos">1331</span>                <span class="n">writer</span><span class="o">.</span><span class="n">aclose</span> <span class="o">=</span> <span class="n">MethodType</span><span class="p">(</span><span class="n">aclose</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
<span class="linenos">1332</span>
<span class="linenos">1333</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
<span class="linenos">1334</span>
<span class="linenos">1335</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1336</span>            <span class="nb">print</span><span class="p">(</span>
<span class="linenos">1337</span>                <span class="s2">&quot;Starting async server on </span><span class="si">{host}</span><span class="s2">:</span><span class="si">{port}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
<span class="linenos">1338</span>            <span class="p">)</span>
<span class="linenos">1339</span>
<span class="linenos">1340</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1341</span>            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">serve</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="n">ssl</span><span class="p">)</span>
<span class="linenos">1342</span>        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1343</span>            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">serve</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
<span class="linenos">1344</span>
<span class="linenos">1345</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">1346</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">1347</span>                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="s2">&quot;serve_forever&quot;</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1348</span>                    <span class="k">try</span><span class="p">:</span>
<span class="linenos">1349</span>                        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
<span class="linenos">1350</span>                    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
<span class="linenos">1351</span>                        <span class="k">pass</span>
<span class="linenos">1352</span>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wait_closed</span><span class="p">()</span>
<span class="linenos">1353</span>                <span class="k">break</span>
<span class="linenos">1354</span>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1355</span>                <span class="c1"># the task hasn&#39;t been initialized in the server object yet</span>
<span class="linenos">1356</span>                <span class="c1"># wait a bit and try again</span>
<span class="linenos">1357</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<span class="linenos">1358</span>
<span class="linenos">1359</span>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1360</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the web server. This function does not normally return, as</span>
<span class="linenos">1361</span><span class="sd">        the server enters an endless listening loop. The :func:`shutdown`</span>
<span class="linenos">1362</span><span class="sd">        function provides a method for terminating the server gracefully.</span>
<span class="linenos">1363</span>
<span class="linenos">1364</span><span class="sd">        :param host: The hostname or IP address of the network interface that</span>
<span class="linenos">1365</span><span class="sd">                     will be listening for requests. A value of ``&#39;0.0.0.0&#39;``</span>
<span class="linenos">1366</span><span class="sd">                     (the default) indicates that the server should listen for</span>
<span class="linenos">1367</span><span class="sd">                     requests on all the available interfaces, and a value of</span>
<span class="linenos">1368</span><span class="sd">                     ``127.0.0.1`` indicates that the server should listen</span>
<span class="linenos">1369</span><span class="sd">                     for requests only on the internal networking interface of</span>
<span class="linenos">1370</span><span class="sd">                     the host.</span>
<span class="linenos">1371</span><span class="sd">        :param port: The port number to listen for requests. The default is</span>
<span class="linenos">1372</span><span class="sd">                     port 5000.</span>
<span class="linenos">1373</span><span class="sd">        :param debug: If ``True``, the server logs debugging information. The</span>
<span class="linenos">1374</span><span class="sd">                      default is ``False``.</span>
<span class="linenos">1375</span><span class="sd">        :param ssl: An ``SSLContext`` instance or ``None`` if the server should</span>
<span class="linenos">1376</span><span class="sd">                    not use TLS. The default is ``None``.</span>
<span class="linenos">1377</span>
<span class="linenos">1378</span><span class="sd">        Example::</span>
<span class="linenos">1379</span>
<span class="linenos">1380</span><span class="sd">            from microdot import Microdot</span>
<span class="linenos">1381</span>
<span class="linenos">1382</span><span class="sd">            app = Microdot()</span>
<span class="linenos">1383</span>
<span class="linenos">1384</span><span class="sd">            @app.route(&#39;/&#39;)</span>
<span class="linenos">1385</span><span class="sd">            async def index(request):</span>
<span class="linenos">1386</span><span class="sd">                return &#39;Hello, world!&#39;</span>
<span class="linenos">1387</span>
<span class="linenos">1388</span><span class="sd">            app.run(debug=True)</span>
<span class="linenos">1389</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1390</span>        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
<span class="linenos">1391</span>            <span class="bp">self</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="n">ssl</span><span class="p">)</span>
<span class="linenos">1392</span>        <span class="p">)</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1393</span>
<span class="linenos">1394</span>    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1395</span><span class="w">        </span><span class="sd">&quot;&quot;&quot;Request a server shutdown. The server will then exit its request</span>
<span class="linenos">1396</span><span class="sd">        listening loop and the :func:`run` function will return. This function</span>
<span class="linenos">1397</span><span class="sd">        can be safely called from a route handler, as it only schedules the</span>
<span class="linenos">1398</span><span class="sd">        server to terminate as soon as the request completes.</span>
<span class="linenos">1399</span>
<span class="linenos">1400</span><span class="sd">        Example::</span>
<span class="linenos">1401</span>
<span class="linenos">1402</span><span class="sd">            @app.route(&#39;/shutdown&#39;)</span>
<span class="linenos">1403</span><span class="sd">            def shutdown(request):</span>
<span class="linenos">1404</span><span class="sd">                request.app.shutdown()</span>
<span class="linenos">1405</span><span class="sd">                return &#39;The server is shutting down...&#39;</span>
<span class="linenos">1406</span><span class="sd">        &quot;&quot;&quot;</span>
<span class="linenos">1407</span>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="linenos">1408</span>
<span class="linenos">1409</span>    <span class="k">def</span><span class="w"> </span><span class="nf">find_route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="linenos">1410</span>        <span class="n">method</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
<span class="linenos">1411</span>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;OPTIONS&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_handler</span><span class="p">:</span>
<span class="linenos">1412</span>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_handler</span><span class="p">(</span><span class="n">req</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">None</span>
<span class="linenos">1413</span>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">:</span>
<span class="linenos">1414</span>            <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;GET&quot;</span>
<span class="linenos">1415</span>        <span class="n">f</span> <span class="o">=</span> <span class="mi">404</span>
<span class="linenos">1416</span>        <span class="n">p</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">1417</span>        <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1418</span>        <span class="k">for</span> <span class="p">(</span>
<span class="linenos">1419</span>            <span class="n">route_methods</span><span class="p">,</span>
<span class="linenos">1420</span>            <span class="n">route_pattern</span><span class="p">,</span>
<span class="linenos">1421</span>            <span class="n">route_handler</span><span class="p">,</span>
<span class="linenos">1422</span>            <span class="n">url_prefix</span><span class="p">,</span>
<span class="linenos">1423</span>            <span class="n">subapp</span><span class="p">,</span>
<span class="linenos">1424</span>        <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="p">:</span>
<span class="linenos">1425</span>            <span class="n">req</span><span class="o">.</span><span class="n">url_args</span> <span class="o">=</span> <span class="n">route_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
<span class="linenos">1426</span>            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">url_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1427</span>                <span class="n">p</span> <span class="o">=</span> <span class="n">url_prefix</span>
<span class="linenos">1428</span>                <span class="n">s</span> <span class="o">=</span> <span class="n">subapp</span>
<span class="linenos">1429</span>                <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">route_methods</span><span class="p">:</span>
<span class="linenos">1430</span>                    <span class="n">f</span> <span class="o">=</span> <span class="n">route_handler</span>
<span class="linenos">1431</span>                    <span class="k">break</span>
<span class="linenos">1432</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">1433</span>                    <span class="n">f</span> <span class="o">=</span> <span class="mi">405</span>
<span class="linenos">1434</span>        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span>
<span class="linenos">1435</span>
<span class="linenos">1436</span>    <span class="k">def</span><span class="w"> </span><span class="nf">default_options_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="linenos">1437</span>        <span class="n">allow</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">1438</span>        <span class="k">for</span> <span class="n">route_methods</span><span class="p">,</span> <span class="n">route_pattern</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="p">:</span>
<span class="linenos">1439</span>            <span class="k">if</span> <span class="n">route_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1440</span>                <span class="n">allow</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">route_methods</span><span class="p">)</span>
<span class="linenos">1441</span>        <span class="k">if</span> <span class="s2">&quot;GET&quot;</span> <span class="ow">in</span> <span class="n">allow</span><span class="p">:</span>
<span class="linenos">1442</span>            <span class="n">allow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">)</span>
<span class="linenos">1443</span>        <span class="n">allow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">)</span>
<span class="linenos">1444</span>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;Allow&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allow</span><span class="p">)}</span>
<span class="linenos">1445</span>
<span class="linenos">1446</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">):</span>
<span class="linenos">1447</span>        <span class="n">req</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1448</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1449</span>            <span class="n">req</span> <span class="o">=</span> <span class="k">await</span> <span class="n">Request</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
<span class="linenos">1450</span>                <span class="bp">self</span><span class="p">,</span> <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span><span class="p">,</span> <span class="n">writer</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s2">&quot;peername&quot;</span><span class="p">)</span>
<span class="linenos">1451</span>            <span class="p">)</span>
<span class="linenos">1452</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1453</span>            <span class="n">print_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<span class="linenos">1454</span>
<span class="linenos">1455</span>        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_request</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="linenos">1456</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1457</span>            <span class="k">if</span> <span class="n">res</span> <span class="o">!=</span> <span class="n">Response</span><span class="o">.</span><span class="n">already_handled</span><span class="p">:</span>  <span class="c1"># pragma: no branch</span>
<span class="linenos">1458</span>                <span class="k">await</span> <span class="n">res</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">writer</span><span class="p">)</span>
<span class="linenos">1459</span>            <span class="k">await</span> <span class="n">writer</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
<span class="linenos">1460</span>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1461</span>            <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="n">MUTED_SOCKET_ERRORS</span><span class="p">:</span>
<span class="linenos">1462</span>                <span class="k">pass</span>
<span class="linenos">1463</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1464</span>                <span class="k">raise</span>
<span class="linenos">1465</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">and</span> <span class="n">req</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1466</span>            <span class="nb">print</span><span class="p">(</span>
<span class="linenos">1467</span>                <span class="s2">&quot;</span><span class="si">{method}</span><span class="s2"> </span><span class="si">{path}</span><span class="s2"> </span><span class="si">{status_code}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
<span class="linenos">1468</span>                    <span class="n">method</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">status_code</span>
<span class="linenos">1469</span>                <span class="p">)</span>
<span class="linenos">1470</span>            <span class="p">)</span>
<span class="linenos">1471</span>
<span class="linenos">1472</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_request_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">local_first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="linenos">1473</span>        <span class="n">handlers</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_handlers&quot;</span><span class="p">)</span>
<span class="linenos">1474</span>        <span class="n">local_handlers</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">1475</span>            <span class="nb">getattr</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="p">,</span> <span class="n">attr</span> <span class="o">+</span> <span class="s2">&quot;_handlers&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span> <span class="k">else</span> <span class="p">[]</span>
<span class="linenos">1476</span>        <span class="p">)</span>
<span class="linenos">1477</span>        <span class="k">return</span> <span class="n">local_handlers</span> <span class="o">+</span> <span class="n">handlers</span> <span class="k">if</span> <span class="n">local_first</span> <span class="k">else</span> <span class="n">handlers</span> <span class="o">+</span> <span class="n">local_handlers</span>
<span class="linenos">1478</span>
<span class="linenos">1479</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">error_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos">1480</span>        <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span> <span class="ow">and</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1481</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span> <span class="n">req</span><span class="p">)</span>
<span class="linenos">1482</span>        <span class="k">elif</span> <span class="n">status_code</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1483</span>            <span class="k">return</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">status_code</span><span class="p">],</span> <span class="n">req</span><span class="p">)</span>
<span class="linenos">1484</span>        <span class="k">return</span> <span class="n">reason</span> <span class="ow">or</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="n">status_code</span>
<span class="linenos">1485</span>
<span class="linenos">1486</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
<span class="linenos">1487</span>        <span class="n">after_request_handled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">1488</span>        <span class="k">if</span> <span class="n">req</span><span class="p">:</span>
<span class="linenos">1489</span>            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">content_length</span> <span class="o">&gt;</span> <span class="n">req</span><span class="o">.</span><span class="n">max_content_length</span><span class="p">:</span>
<span class="linenos">1490</span>                <span class="c1"># the request body is larger than allowed</span>
<span class="linenos">1491</span>                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">413</span><span class="p">,</span> <span class="s2">&quot;Payload too large&quot;</span><span class="p">)</span>
<span class="linenos">1492</span>            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1493</span>                <span class="c1"># find the route in the app&#39;s URL map</span>
<span class="linenos">1494</span>                <span class="n">f</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">url_prefix</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_route</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="linenos">1495</span>
<span class="linenos">1496</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">1497</span>                    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1498</span>                    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="linenos">1499</span>                        <span class="c1"># invoke the before request handlers</span>
<span class="linenos">1500</span>                        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_request_handlers</span><span class="p">(</span>
<span class="linenos">1501</span>                            <span class="n">req</span><span class="p">,</span> <span class="s2">&quot;before_request&quot;</span><span class="p">,</span> <span class="kc">False</span>
<span class="linenos">1502</span>                        <span class="p">):</span>
<span class="linenos">1503</span>                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
<span class="linenos">1504</span>                            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
<span class="linenos">1505</span>                                <span class="k">break</span>
<span class="linenos">1506</span>
<span class="linenos">1507</span>                        <span class="c1"># invoke the endpoint handler</span>
<span class="linenos">1508</span>                        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1509</span>                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">**</span><span class="n">req</span><span class="o">.</span><span class="n">url_args</span><span class="p">)</span>
<span class="linenos">1510</span>
<span class="linenos">1511</span>                        <span class="c1"># process the response</span>
<span class="linenos">1512</span>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos">1513</span>                            <span class="c1"># an integer response is taken as a status code</span>
<span class="linenos">1514</span>                            <span class="c1"># with an empty body</span>
<span class="linenos">1515</span>                            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">res</span>
<span class="linenos">1516</span>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="linenos">1517</span>                            <span class="c1"># handle a tuple response</span>
<span class="linenos">1518</span>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos">1519</span>                                <span class="c1"># a tuple that starts with an int has an empty</span>
<span class="linenos">1520</span>                                <span class="c1"># body</span>
<span class="linenos">1521</span>                                <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">{})</span>
<span class="linenos">1522</span>                            <span class="n">body</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="linenos">1523</span>                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
<span class="linenos">1524</span>                                <span class="c1"># extract the status code and headers (if</span>
<span class="linenos">1525</span>                                <span class="c1"># available)</span>
<span class="linenos">1526</span>                                <span class="n">status_code</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">1527</span>                                <span class="n">headers</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="p">{}</span>
<span class="linenos">1528</span>                            <span class="k">else</span><span class="p">:</span>
<span class="linenos">1529</span>                                <span class="c1"># if the status code is missing, assume 200</span>
<span class="linenos">1530</span>                                <span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
<span class="linenos">1531</span>                                <span class="n">headers</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos">1532</span>                            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
<span class="linenos">1533</span>                        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
<span class="linenos">1534</span>                            <span class="c1"># any other response types are wrapped in a</span>
<span class="linenos">1535</span>                            <span class="c1"># Response object</span>
<span class="linenos">1536</span>                            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="linenos">1537</span>
<span class="linenos">1538</span>                        <span class="c1"># invoke the after request handlers</span>
<span class="linenos">1539</span>                        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_request_handlers</span><span class="p">(</span>
<span class="linenos">1540</span>                            <span class="n">req</span><span class="p">,</span> <span class="s2">&quot;after_request&quot;</span><span class="p">,</span> <span class="kc">True</span>
<span class="linenos">1541</span>                        <span class="p">):</span>
<span class="linenos">1542</span>                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res</span>
<span class="linenos">1543</span>                        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">after_request_handlers</span><span class="p">:</span>
<span class="linenos">1544</span>                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res</span>
<span class="linenos">1545</span>                        <span class="n">after_request_handled</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">1546</span>                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<span class="linenos">1547</span>                        <span class="c1"># the response from an OPTIONS request is a dict with</span>
<span class="linenos">1548</span>                        <span class="c1"># headers</span>
<span class="linenos">1549</span>                        <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">headers</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
<span class="linenos">1550</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">1551</span>                        <span class="c1"># if the route is not found, return a 404 or 405</span>
<span class="linenos">1552</span>                        <span class="c1"># response as appropriate</span>
<span class="linenos">1553</span>                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;Not found&quot;</span><span class="p">)</span>
<span class="linenos">1554</span>                <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos">1555</span>                    <span class="c1"># an HTTP exception was raised while handling this request</span>
<span class="linenos">1556</span>                    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">exc</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
<span class="linenos">1557</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
<span class="linenos">1558</span>                    <span class="c1"># an unexpected exception was raised while handling this</span>
<span class="linenos">1559</span>                    <span class="c1"># request</span>
<span class="linenos">1560</span>                    <span class="n">print_exception</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
<span class="linenos">1561</span>
<span class="linenos">1562</span>                    <span class="c1"># invoke the error handler for the exception class if one</span>
<span class="linenos">1563</span>                    <span class="c1"># exists</span>
<span class="linenos">1564</span>                    <span class="n">handler</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1565</span>                    <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">1566</span>                    <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span> <span class="ow">and</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1567</span>                        <span class="n">handler</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span>
<span class="linenos">1568</span>                    <span class="k">elif</span> <span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1569</span>                        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="p">]</span>
<span class="linenos">1570</span>                    <span class="k">else</span><span class="p">:</span>
<span class="linenos">1571</span>                        <span class="c1"># walk up the exception class hierarchy to try to find</span>
<span class="linenos">1572</span>                        <span class="c1"># a handler</span>
<span class="linenos">1573</span>                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mro</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]:</span>
<span class="linenos">1574</span>                            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1575</span>                                <span class="n">handler</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">subapp</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
<span class="linenos">1576</span>                                <span class="k">break</span>
<span class="linenos">1577</span>                            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">:</span>
<span class="linenos">1578</span>                                <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
<span class="linenos">1579</span>                                <span class="k">break</span>
<span class="linenos">1580</span>                    <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
<span class="linenos">1581</span>                        <span class="k">try</span><span class="p">:</span>
<span class="linenos">1582</span>                            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
<span class="linenos">1583</span>                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc2</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
<span class="linenos">1584</span>                            <span class="n">print_exception</span><span class="p">(</span><span class="n">exc2</span><span class="p">)</span>
<span class="linenos">1585</span>                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">1586</span>                        <span class="c1"># if there is still no response, issue a 500 error</span>
<span class="linenos">1587</span>                        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span>
<span class="linenos">1588</span>                            <span class="n">req</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s2">&quot;Internal server error&quot;</span>
<span class="linenos">1589</span>                        <span class="p">)</span>
<span class="linenos">1590</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">1591</span>            <span class="c1"># if the request could not be parsed, issue a 400 error</span>
<span class="linenos">1592</span>            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_response</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s2">&quot;Bad request&quot;</span><span class="p">)</span>
<span class="linenos">1593</span>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
<span class="linenos">1594</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="linenos">1595</span>        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">Response</span><span class="p">):</span>
<span class="linenos">1596</span>            <span class="n">res</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<span class="linenos">1597</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">after_request_handled</span><span class="p">:</span>
<span class="linenos">1598</span>            <span class="c1"># if the request did not finish due to an error, invoke the after</span>
<span class="linenos">1599</span>            <span class="c1"># error request handler</span>
<span class="linenos">1600</span>            <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_request_handlers</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="s2">&quot;after_error_request&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
<span class="linenos">1601</span>                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">invoke_handler</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span> <span class="ow">or</span> <span class="n">res</span>
<span class="linenos">1602</span>        <span class="n">res</span><span class="o">.</span><span class="n">is_head</span> <span class="o">=</span> <span class="n">req</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;HEAD&quot;</span>
<span class="linenos">1603</span>        <span class="k">return</span> <span class="n">res</span>
<span class="linenos">1604</span>
<span class="linenos">1605</span>
<span class="linenos">1606</span><span class="n">Response</span><span class="o">.</span><span class="n">already_handled</span> <span class="o">=</span> <span class="n">Response</span><span class="p">()</span>
<span class="linenos">1607</span>
<span class="linenos">1608</span><span class="n">abort</span> <span class="o">=</span> <span class="n">Microdot</span><span class="o">.</span><span class="n">abort</span>
<span class="linenos">1609</span><span class="c1"># redirect = Response.redirect</span>
<span class="linenos">1610</span><span class="c1"># send_file = Response.send_file</span>
<span class="linenos">1611</span>
<span class="linenos">1612</span>
<span class="linenos">1613</span><span class="c1"># ===========================</span>
<span class="linenos">1614</span><span class="c1"># microdot_test.py</span>
<span class="linenos">1615</span><span class="c1"># ===========================</span>
<span class="linenos">1616</span><span class="k">class</span><span class="w"> </span><span class="nc">HttpServer</span><span class="p">:</span>
<span class="linenos">1617</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">1618</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">1619</span>    <span class="p">):</span>
<span class="linenos">1620</span>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">60000</span>
<span class="linenos">1621</span>
<span class="linenos">1622</span>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">Microdot</span><span class="p">()</span>
<span class="linenos">1623</span>        <span class="n">Request</span><span class="o">.</span><span class="n">max_content_length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos">1624</span>        <span class="n">Request</span><span class="o">.</span><span class="n">max_body_length</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span>
<span class="linenos">1625</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;init microdot app ok&quot;</span><span class="p">)</span>
<span class="linenos">1626</span>
<span class="linenos">1627</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_register_routes</span><span class="p">()</span>
<span class="linenos">1628</span>
<span class="linenos">1629</span>    <span class="k">def</span><span class="w"> </span><span class="nf">_register_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1630</span>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="linenos">1631</span>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/hello&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])(</span><span class="bp">self</span><span class="o">.</span><span class="n">hello</span><span class="p">)</span>
<span class="linenos">1632</span>        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api/app/config/meta&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_meta</span><span class="p">)</span>
<span class="linenos">1633</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;register routers ok&quot;</span><span class="p">)</span>
<span class="linenos">1634</span>
<span class="linenos">1635</span>    <span class="k">def</span><span class="w"> </span><span class="nf">hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="linenos">1636</span>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hello&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span><span class="p">}</span>
<span class="linenos">1637</span>
<span class="linenos">1638</span>    <span class="k">def</span><span class="w"> </span><span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="linenos">1639</span>        <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;http://115.190.27.121/assets&quot;</span>
<span class="linenos">1640</span>        <span class="n">html</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&lt;!doctype html&gt;&lt;meta charset=&quot;utf-8&quot;&gt;&lt;script defer=&quot;defer&quot; src=&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">/dic.js&quot;&gt;&lt;/script&gt;&lt;script defer=&quot;defer&quot; src=&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">/di.js&quot;&gt;&lt;/script&gt;&lt;link href=&quot;</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s1">/di.css&quot; rel=&quot;stylesheet&quot;&gt;&lt;div id=&quot;app&quot; style=&quot;width: 100%; height: 100%;&quot;&gt;&lt;/div&gt;&#39;</span>
<span class="linenos">1641</span>        <span class="k">return</span> <span class="p">(</span>
<span class="linenos">1642</span>            <span class="n">html</span><span class="p">,</span>
<span class="linenos">1643</span>            <span class="mi">200</span><span class="p">,</span>
<span class="linenos">1644</span>            <span class="p">{</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html&quot;</span><span class="p">},</span>
<span class="linenos">1645</span>        <span class="p">)</span>
<span class="linenos">1646</span>
<span class="linenos">1647</span>    <span class="k">def</span><span class="w"> </span><span class="nf">get_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
<span class="linenos">1648</span>        <span class="k">return</span> <span class="p">{</span>
<span class="linenos">1649</span>            <span class="s2">&quot;ble5_protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1650</span>            <span class="s2">&quot;conn_timeout&quot;</span><span class="p">:</span> <span class="s2">&quot;15000&quot;</span><span class="p">,</span>
<span class="linenos">1651</span>            <span class="s2">&quot;mqtt_password&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1652</span>            <span class="s2">&quot;http_port&quot;</span><span class="p">:</span> <span class="s2">&quot;60000&quot;</span><span class="p">,</span>
<span class="linenos">1653</span>            <span class="s2">&quot;scan_filter_duplicates&quot;</span><span class="p">:</span> <span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="linenos">1654</span>            <span class="s2">&quot;forward_protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;mqtt&quot;</span><span class="p">,</span>
<span class="linenos">1655</span>            <span class="s2">&quot;mqtt_host&quot;</span><span class="p">:</span> <span class="s2">&quot;115.190.27.121&quot;</span><span class="p">,</span>
<span class="linenos">1656</span>            <span class="s2">&quot;mqtt_username&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1657</span>            <span class="s2">&quot;scan_filter_rssi&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1658</span>            <span class="s2">&quot;mqtt_qos&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="linenos">1659</span>            <span class="s2">&quot;conn_chip&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1660</span>            <span class="s2">&quot;scan_mode&quot;</span><span class="p">:</span> <span class="s2">&quot;active&quot;</span><span class="p">,</span>
<span class="linenos">1661</span>            <span class="s2">&quot;scan_filter_name&quot;</span><span class="p">:</span> <span class="s2">&quot;cassia-device*&quot;</span><span class="p">,</span>
<span class="linenos">1662</span>            <span class="s2">&quot;mqtt_port&quot;</span><span class="p">:</span> <span class="s2">&quot;61883&quot;</span><span class="p">,</span>
<span class="linenos">1663</span>            <span class="s2">&quot;conn_fail_retry_times&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
<span class="linenos">1664</span>            <span class="s2">&quot;scan_filter_mac&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1665</span>            <span class="s2">&quot;forward_raw_scan&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1666</span>            <span class="s2">&quot;scan_chip&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1667</span>            <span class="s2">&quot;scan_report_interval&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1668</span>            <span class="s2">&quot;gateway_mac&quot;</span><span class="p">:</span> <span class="s2">&quot;CC:1B:E0:E4:A3:5C&quot;</span><span class="p">,</span>
<span class="linenos">1669</span>            <span class="s2">&quot;forward_raw_notify&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="linenos">1670</span>            <span class="s2">&quot;mqtt_topic_prefix&quot;</span><span class="p">:</span> <span class="s2">&quot;/dev&quot;</span><span class="p">,</span>
<span class="linenos">1671</span>        <span class="p">}</span>
<span class="linenos">1672</span>
<span class="linenos">1673</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1674</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_server</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="linenos">1675</span>
<span class="linenos">1676</span>    <span class="k">def</span><span class="w"> </span><span class="nf">co_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">1677</span>        <span class="k">return</span> <span class="p">[</span>
<span class="linenos">1678</span>            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span>
<span class="linenos">1679</span>        <span class="p">]</span>
<span class="linenos">1680</span>
<span class="linenos">1681</span>
<span class="linenos">1682</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
<span class="linenos">1683</span>    <span class="n">server</span> <span class="o">=</span> <span class="n">HttpServer</span><span class="p">()</span>
<span class="linenos">1684</span>    <span class="n">tasks</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">co_tasks</span><span class="p">()</span>
<span class="linenos">1685</span>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
<span class="linenos">1686</span>
<span class="linenos">1687</span>
<span class="linenos">1688</span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="micropython_mqtt.html" class="btn btn-neutral float-left" title="micropython-mqtt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../micropython_libs/index.html" class="btn btn-neutral float-right" title="MicroPython Libraries" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, CassiaNetworks.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Language</span>
    en
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>语言</dt>
      
      
      
      <dd>
        <a href="../../html/third_libs/microdot.html">简体中文</a>
      </dd>
      
      
      
      
    </dl>
    <dl>
      <dt>Versions</dt>
      
      <dd>
        <a href="../../../2.2.mp.2509291554/html_en/third_libs/microdot.html">2.2.mp.2509291554</a>
      </dd>
      
      <dd>
        <a href="../../../2.2.mp.2509241710/html_en/third_libs/microdot.html">2.2.mp.2509241710</a>
      </dd>
      
      <dd>
        <a href="../../../2.2.mp.2509081030/html_en/third_libs/microdot.html">2.2.mp.2509081030</a>
      </dd>
      
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>