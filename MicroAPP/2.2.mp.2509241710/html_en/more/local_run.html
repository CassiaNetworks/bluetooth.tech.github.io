

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Run Locally &mdash; Micro APP 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=3abfe436" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=01f34227"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Complete Example" href="demo.html" />
    <link rel="prev" title="Compile to mpy" href="mpy.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Micro APP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resource/index.html">Version &amp; Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassiablue_api/index.html">Cassiablue API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassiamqtt_api/index.html">Cassiamqtt API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cassia_libs/index.html">Cassia Common Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../third_libs/index.html">Common Third-Party Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../micropython_libs/index.html">MicroPython Libraries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">More Reference</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="mpy.html">Compile to mpy</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Run Locally</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">System Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Download Source Code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Install Dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">Compile and Build</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">Check Version</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">Prepare Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Run the Script</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cassiablue-api-mock">Cassiablue API Mock</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cassiamqtt-api-mock">Cassiamqtt API Mock</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="demo.html">Complete Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding.html">FAQ</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Micro APP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">More Reference</a></li>
      <li class="breadcrumb-item active">Run Locally</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/more/local_run.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>Run Locally<a class="headerlink" href="#id1" title="Link to this heading"></a></h1>
<p><code class="docutils literal notranslate"><span class="pre">micropython</span></code> supports multiple platforms and can be used to run and test the basic APP logic locally.</p>
<section id="id2">
<h2>System Information<a class="headerlink" href="#id2" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cat<span class="w"> </span>/etc/issue
Ubuntu<span class="w"> </span><span class="m">22</span>.04<span class="w"> </span>LTS<span class="w"> </span><span class="se">\n</span><span class="w"> </span><span class="se">\l</span>

uname<span class="w"> </span>-a
Linux<span class="w"> </span>VM-0-9-ubuntu<span class="w"> </span><span class="m">5</span>.15.0-106-generic
</pre></div>
</div>
</section>
<section id="id3">
<h2>Download Source Code<a class="headerlink" href="#id3" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>--branch<span class="w"> </span>v1.24.1<span class="w"> </span>--depth<span class="w"> </span><span class="m">1</span><span class="w"> </span>https://github.com/micropython/micropython.git
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
</pre></div>
</div>
</section>
<section id="id4">
<h2>Install Dependencies<a class="headerlink" href="#id4" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt<span class="w"> </span>update
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>build-essential<span class="w"> </span>git<span class="w"> </span>pkg-config<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libffi-dev<span class="w"> </span>libssl-dev<span class="w"> </span>libbz2-dev<span class="w"> </span>liblzma-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libreadline-dev<span class="w"> </span>libsqlite3-dev<span class="w"> </span>libgdbm-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libncurses5-dev<span class="w"> </span>zlib1g-dev<span class="w"> </span>libmpdec-dev<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>libmbedtls-dev<span class="w"> </span>libdb5.3-dev<span class="w"> </span>uuid-dev
</pre></div>
</div>
</section>
<section id="id5">
<h2>Compile and Build<a class="headerlink" href="#id5" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>micropython/ports/unix
make<span class="w"> </span>clean
make<span class="w"> </span>-j<span class="k">$(</span>nproc<span class="k">)</span><span class="w"> </span><span class="nv">MICROPY_PY_USER_CMODULE</span><span class="o">=</span><span class="m">0</span>


<span class="c1"># LINK build-standard/micropython</span>
<span class="c1">#   text       data     bss     dec     hex filename</span>
<span class="c1"># 764607      69328    7088  841023   cd53f build-standard/micropython</span>
</pre></div>
</div>
</section>
<section id="id6">
<h2>Check Version<a class="headerlink" href="#id6" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./build-standard/micropython<span class="w"> </span>--version

<span class="c1"># MicroPython v1.24.1 on 2025-09-09; linux [GCC 11.2.0] version</span>
</pre></div>
</div>
</section>
<section id="id7">
<h2>Prepare Script<a class="headerlink" href="#id7" title="Link to this heading"></a></h2>
<p>Prepare hello.py with the following script content:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;print(&quot;hello&quot;)&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>hello.py
</pre></div>
</div>
</section>
<section id="id8">
<h2>Run the Script<a class="headerlink" href="#id8" title="Link to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./build-standard/micropython<span class="w"> </span>hello.py
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hello
</pre></div>
</div>
</section>
<section id="cassiablue-api-mock">
<h2>Cassiablue API Mock<a class="headerlink" href="#cassiablue-api-mock" title="Link to this heading"></a></h2>
<p>To debug code related to the Cassiablue API, you can refer to the following implementation using the gateway RESTful API to mock the Cassiablue API, which allows for quick testing of basic logic and functionality.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>仅用于本地调试代码基本逻辑，勿用于压力测试和稳定性测试</p></li>
<li><p>The actual script execution results should be based on operation within the M2000 gateway.</p></li>
</ul>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Module name: cassiablue.py</span>
<span class="linenos">  3</span><span class="sd">Purpose: Local MicroPython debugging mock. Exposes the same high-level API as the real gateway by forwarding calls to its REST + Server-Sent-Events interface, so you can develop and test your MicroPython logic on a PC without flashing firmware.</span>
<span class="linenos">  4</span><span class="sd">MicroPython compatibility: v1.24.1</span>
<span class="linenos">  5</span><span class="sd">Important: Do **not** copy this file into the gateway itself—the gateway already contains a native C implementation. This module is **only** for convenient desktop debugging and has no performance guarantees.</span>
<span class="linenos">  6</span><span class="sd">Usage: Change the variable `GATEWAY` to the actual IP address of your gateway.</span>
<span class="linenos">  7</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="n">GATEWAY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos"> 10</span>
<span class="linenos"> 11</span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="linenos"> 12</span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="kn">from</span><span class="w"> </span><span class="nn">cassia_log</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="linenos"> 15</span><span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="linenos"> 16</span>
<span class="linenos"> 17</span><span class="k">try</span><span class="p">:</span>
<span class="linenos"> 18</span>    <span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
<span class="linenos"> 19</span><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
<span class="linenos"> 20</span>    <span class="k">pass</span>
<span class="linenos"> 21</span>
<span class="linenos"> 22</span>
<span class="linenos"> 23</span><span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;__mock_cassiablue__&quot;</span><span class="p">)</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="k">class</span><span class="w"> </span><span class="nc">AsyncQueue</span><span class="p">:</span>
<span class="linenos"> 27</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos"> 29</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ThreadSafeFlag</span><span class="p">()</span>
<span class="linenos"> 30</span>
<span class="linenos"> 31</span>    <span class="k">def</span><span class="w"> </span><span class="nf">put_nowait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="linenos"> 32</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="linenos"> 33</span>        <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 36</span>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">:</span>
<span class="linenos"> 37</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flag</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="linenos"> 38</span>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span>
<span class="linenos"> 41</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 42</span>    <span class="k">global</span> <span class="n">GATEWAY</span>
<span class="linenos"> 43</span>    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">GATEWAY</span><span class="si">}{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;send cmd start:&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
<span class="linenos"> 46</span>
<span class="linenos"> 47</span>    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
<span class="linenos"> 48</span>        <span class="k">if</span> <span class="n">body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 49</span>            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
<span class="linenos"> 50</span>                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
<span class="linenos"> 51</span>            <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
<span class="linenos"> 52</span>                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<span class="linenos"> 53</span>                    <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
<span class="linenos"> 54</span>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text</span>
<span class="linenos"> 55</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 56</span>                    <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
<span class="linenos"> 57</span>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">text</span>
<span class="linenos"> 58</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 59</span>            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
<span class="linenos"> 60</span>                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<span class="linenos"> 61</span>                    <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
<span class="linenos"> 62</span>                    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">text</span>
<span class="linenos"> 63</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos"> 64</span>                    <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
<span class="linenos"> 65</span>                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">text</span>
<span class="linenos"> 66</span>
<span class="linenos"> 67</span>
<span class="linenos"> 68</span><span class="c1"># address is a string like &quot;00:11:22:33:44:55&quot;</span>
<span class="linenos"> 69</span><span class="c1"># params is a json string like &#39;{&quot;param1&quot;: &quot;value1&quot;, &quot;param2&quot;: &quot;value2&quot;}&#39;</span>
<span class="linenos"> 70</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 71</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span><span class="p">:</span>
<span class="linenos"> 72</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address cannot be empty&quot;</span><span class="p">)</span>
<span class="linenos"> 73</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/gap/nodes/</span><span class="si">{}</span><span class="s2">/connection&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="linenos"> 74</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="c1"># address is a string like &quot;00:11:22:33:44:55&quot;</span>
<span class="linenos"> 78</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
<span class="linenos"> 79</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span><span class="p">:</span>
<span class="linenos"> 80</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address cannot be empty&quot;</span><span class="p">)</span>
<span class="linenos"> 81</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/gap/nodes/</span><span class="si">{}</span><span class="s2">/connection&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="linenos"> 82</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">)</span>
<span class="linenos"> 83</span>
<span class="linenos"> 84</span>
<span class="linenos"> 85</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_connected_devices</span><span class="p">():</span>
<span class="linenos"> 86</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="s2">&quot;/gap/nodes&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">gatt_discover</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
<span class="linenos"> 90</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span><span class="p">:</span>
<span class="linenos"> 91</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address cannot be empty&quot;</span><span class="p">)</span>
<span class="linenos"> 92</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/gatt/nodes/</span><span class="si">{}</span><span class="s2">/services/characteristics/descriptors&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="linenos"> 93</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">gatt_read</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
<span class="linenos"> 97</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">handle</span><span class="p">:</span>
<span class="linenos"> 98</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address and handle cannot be empty&quot;</span><span class="p">)</span>
<span class="linenos"> 99</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/gatt/nodes/</span><span class="si">{}</span><span class="s2">/handle/</span><span class="si">{}</span><span class="s2">/value&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>
<span class="linenos">100</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="linenos">101</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">gatt_write</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="linenos">104</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">handle</span> <span class="ow">or</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">105</span>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Address, handle, and value cannot be empty&quot;</span><span class="p">)</span>
<span class="linenos">106</span>    <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;/gatt/nodes/</span><span class="si">{}</span><span class="s2">/handle/</span><span class="si">{}</span><span class="s2">/value/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
<span class="linenos">107</span>    <span class="k">return</span> <span class="k">await</span> <span class="n">send_cmd</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">)</span>
<span class="linenos">108</span>
<span class="linenos">109</span>
<span class="linenos">110</span><span class="k">class</span><span class="w"> </span><span class="nc">SSEClient</span><span class="p">:</span>
<span class="linenos">111</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<span class="linenos">112</span>        <span class="bp">self</span><span class="p">,</span>
<span class="linenos">113</span>        <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">114</span>        <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="linenos">115</span>        <span class="n">reconnect_delay</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos">116</span>    <span class="p">):</span>
<span class="linenos">117</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="linenos">118</span>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
<span class="linenos">119</span>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
<span class="linenos">120</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">=</span> <span class="n">reconnect_delay</span>
<span class="linenos">121</span>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos">122</span>        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">AsyncQueue</span><span class="p">()</span>
<span class="linenos">123</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">124</span>        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">125</span>
<span class="linenos">126</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">127</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect to sse start: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">128</span>        <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="linenos">129</span>        <span class="n">req</span> <span class="o">=</span> <span class="p">(</span>
<span class="linenos">130</span>            <span class="sa">f</span><span class="s2">&quot;GET </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2"> HTTP/1.1</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="linenos">131</span>            <span class="sa">f</span><span class="s2">&quot;Accept: text/event-stream</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="linenos">132</span>            <span class="sa">f</span><span class="s2">&quot;Host: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="linenos">133</span>            <span class="sa">f</span><span class="s2">&quot;Connection: keep-alive</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="linenos">134</span>            <span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span>
<span class="linenos">135</span>        <span class="p">)</span>
<span class="linenos">136</span>        <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
<span class="linenos">137</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
<span class="linenos">138</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect to sse ok: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">139</span>
<span class="linenos">140</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">co_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">141</span>        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
<span class="linenos">142</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">143</span>                <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="linenos">144</span>
<span class="linenos">145</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
<span class="linenos">146</span>                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;connection closed&quot;</span><span class="p">)</span>
<span class="linenos">147</span>
<span class="linenos">148</span>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="linenos">149</span>
<span class="linenos">150</span>                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
<span class="linenos">151</span>                    <span class="k">continue</span>
<span class="linenos">152</span>
<span class="linenos">153</span>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;raw line:&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<span class="linenos">154</span>                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">,</span> <span class="s2">&quot;[&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;data: {&quot;</span><span class="p">)):</span>
<span class="linenos">155</span>                    <span class="k">continue</span>
<span class="linenos">156</span>
<span class="linenos">157</span>                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;raw line:&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<span class="linenos">158</span>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;data: &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">159</span>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">160</span>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">161</span>                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="linenos">162</span>
<span class="linenos">163</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">164</span>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
<span class="linenos">165</span>
<span class="linenos">166</span>                    <span class="k">if</span> <span class="s2">&quot;bdaddrs&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
<span class="linenos">167</span>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bdaddr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bdaddrs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;bdaddr&quot;</span><span class="p">]</span>
<span class="linenos">168</span>                        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bdaddrType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bdaddrs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;bdaddrType&quot;</span><span class="p">]</span>
<span class="linenos">169</span>                        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;bdaddrs&quot;</span><span class="p">]</span>
<span class="linenos">170</span>
<span class="linenos">171</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="linenos">172</span>                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">173</span>                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;parse data error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<span class="linenos">174</span>
<span class="linenos">175</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">176</span>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;sse disconnected:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
<span class="linenos">177</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span><span class="p">)</span>
<span class="linenos">178</span>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;reconnecting...&quot;</span><span class="p">)</span>
<span class="linenos">179</span>
<span class="linenos">180</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">181</span>        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
<span class="linenos">182</span>
<span class="linenos">183</span>
<span class="linenos">184</span><span class="c1">#######################</span>
<span class="linenos">185</span><span class="c1"># scan sse</span>
<span class="linenos">186</span><span class="c1">#######################</span>
<span class="linenos">187</span>
<span class="linenos">188</span><span class="n">scan_sse_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSEClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">189</span>
<span class="linenos">190</span>
<span class="linenos">191</span><span class="k">class</span><span class="w"> </span><span class="nc">BLEScanResult</span><span class="p">:</span>
<span class="linenos">192</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">193</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">194</span>
<span class="linenos">195</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">196</span>        <span class="k">global</span> <span class="n">scan_sse_client</span>
<span class="linenos">197</span>        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">scan_sse_client</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="linenos">198</span>        <span class="k">return</span> <span class="n">item</span>
<span class="linenos">199</span>
<span class="linenos">200</span>
<span class="linenos">201</span><span class="k">def</span><span class="w"> </span><span class="nf">scan_result</span><span class="p">():</span>
<span class="linenos">202</span>    <span class="k">return</span> <span class="n">BLEScanResult</span><span class="p">()</span>
<span class="linenos">203</span>
<span class="linenos">204</span>
<span class="linenos">205</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_scan</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">206</span>    <span class="k">global</span> <span class="n">scan_sse_client</span>
<span class="linenos">207</span>
<span class="linenos">208</span>    <span class="n">qs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">209</span>    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">210</span>        <span class="n">qs</span> <span class="o">=</span> <span class="s2">&quot;event=1&quot;</span>
<span class="linenos">211</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">212</span>        <span class="k">if</span> <span class="s2">&quot;event=1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
<span class="linenos">213</span>            <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span> <span class="o">+</span> <span class="s2">&quot;event=1&amp;&quot;</span>
<span class="linenos">214</span>        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span> <span class="o">+</span> <span class="n">query</span>
<span class="linenos">215</span>
<span class="linenos">216</span>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start scan:&quot;</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="linenos">217</span>
<span class="linenos">218</span>    <span class="n">scan_sse_client</span> <span class="o">=</span> <span class="n">SSEClient</span><span class="p">(</span>
<span class="linenos">219</span>        <span class="n">host</span><span class="o">=</span><span class="n">GATEWAY</span><span class="p">,</span>
<span class="linenos">220</span>        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/gap/nodes?</span><span class="si">{</span><span class="n">qs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos">221</span>    <span class="p">)</span>
<span class="linenos">222</span>
<span class="linenos">223</span>    <span class="k">await</span> <span class="n">scan_sse_client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">224</span>
<span class="linenos">225</span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">scan_sse_client</span><span class="o">.</span><span class="n">co_read</span><span class="p">())</span>
<span class="linenos">226</span>
<span class="linenos">227</span>    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span>
<span class="linenos">228</span>
<span class="linenos">229</span>
<span class="linenos">230</span><span class="c1">#######################</span>
<span class="linenos">231</span><span class="c1"># notify sse</span>
<span class="linenos">232</span><span class="c1">#######################</span>
<span class="linenos">233</span>
<span class="linenos">234</span><span class="n">notify_sse_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSEClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">235</span>
<span class="linenos">236</span>
<span class="linenos">237</span><span class="k">class</span><span class="w"> </span><span class="nc">BLENotifyResult</span><span class="p">:</span>
<span class="linenos">238</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">239</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">240</span>
<span class="linenos">241</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">242</span>        <span class="k">global</span> <span class="n">notify_sse_client</span>
<span class="linenos">243</span>        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">notify_sse_client</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="linenos">244</span>        <span class="k">return</span> <span class="n">item</span>
<span class="linenos">245</span>
<span class="linenos">246</span>
<span class="linenos">247</span><span class="k">def</span><span class="w"> </span><span class="nf">notify_result</span><span class="p">():</span>
<span class="linenos">248</span>    <span class="k">return</span> <span class="n">BLENotifyResult</span><span class="p">()</span>
<span class="linenos">249</span>
<span class="linenos">250</span>
<span class="linenos">251</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_recv_notify</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="linenos">252</span>    <span class="k">global</span> <span class="n">notify_sse_client</span>
<span class="linenos">253</span>
<span class="linenos">254</span>    <span class="n">qs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">255</span>    <span class="k">if</span> <span class="n">query</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos">256</span>        <span class="n">qs</span> <span class="o">=</span> <span class="s2">&quot;event=1&quot;</span>
<span class="linenos">257</span>    <span class="k">else</span><span class="p">:</span>
<span class="linenos">258</span>        <span class="k">if</span> <span class="s2">&quot;event=1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
<span class="linenos">259</span>            <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span> <span class="o">+</span> <span class="s2">&quot;event=1&amp;&quot;</span>
<span class="linenos">260</span>        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span> <span class="o">+</span> <span class="n">query</span>
<span class="linenos">261</span>
<span class="linenos">262</span>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start notify:&quot;</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="linenos">263</span>
<span class="linenos">264</span>    <span class="n">notify_sse_client</span> <span class="o">=</span> <span class="n">SSEClient</span><span class="p">(</span>
<span class="linenos">265</span>        <span class="n">host</span><span class="o">=</span><span class="n">GATEWAY</span><span class="p">,</span>
<span class="linenos">266</span>        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/gatt/nodes?</span><span class="si">{</span><span class="n">qs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="linenos">267</span>    <span class="p">)</span>
<span class="linenos">268</span>
<span class="linenos">269</span>    <span class="k">await</span> <span class="n">notify_sse_client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">270</span>
<span class="linenos">271</span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">notify_sse_client</span><span class="o">.</span><span class="n">co_read</span><span class="p">())</span>
<span class="linenos">272</span>
<span class="linenos">273</span>    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span>
<span class="linenos">274</span>
<span class="linenos">275</span>
<span class="linenos">276</span><span class="c1">#######################</span>
<span class="linenos">277</span><span class="c1"># state sse</span>
<span class="linenos">278</span><span class="c1">#######################</span>
<span class="linenos">279</span>
<span class="linenos">280</span><span class="n">state_sse_client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SSEClient</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos">281</span>
<span class="linenos">282</span>
<span class="linenos">283</span><span class="k">class</span><span class="w"> </span><span class="nc">BLEConnectionResult</span><span class="p">:</span>
<span class="linenos">284</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">285</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos">286</span>
<span class="linenos">287</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">288</span>        <span class="k">global</span> <span class="n">state_sse_client</span>
<span class="linenos">289</span>        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">state_sse_client</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="linenos">290</span>        <span class="k">return</span> <span class="n">item</span>
<span class="linenos">291</span>
<span class="linenos">292</span>
<span class="linenos">293</span><span class="k">def</span><span class="w"> </span><span class="nf">connection_result</span><span class="p">():</span>
<span class="linenos">294</span>    <span class="k">return</span> <span class="n">BLEConnectionResult</span><span class="p">()</span>
<span class="linenos">295</span>
<span class="linenos">296</span>
<span class="linenos">297</span><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start_recv_connection_state</span><span class="p">():</span>
<span class="linenos">298</span>    <span class="k">global</span> <span class="n">state_sse_client</span>
<span class="linenos">299</span>
<span class="linenos">300</span>    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;start state&quot;</span><span class="p">)</span>
<span class="linenos">301</span>
<span class="linenos">302</span>    <span class="n">state_sse_client</span> <span class="o">=</span> <span class="n">SSEClient</span><span class="p">(</span>
<span class="linenos">303</span>        <span class="n">host</span><span class="o">=</span><span class="n">GATEWAY</span><span class="p">,</span>
<span class="linenos">304</span>        <span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/management/nodes/connection-state&quot;</span><span class="p">,</span>
<span class="linenos">305</span>    <span class="p">)</span>
<span class="linenos">306</span>
<span class="linenos">307</span>    <span class="k">await</span> <span class="n">state_sse_client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos">308</span>    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">state_sse_client</span><span class="o">.</span><span class="n">co_read</span><span class="p">())</span>
<span class="linenos">309</span>
<span class="linenos">310</span>    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;OK&quot;</span>
<span class="linenos">311</span>
<span class="linenos">312</span>
<span class="linenos">313</span><span class="k">def</span><span class="w"> </span><span class="nf">set_gateway</span><span class="p">(</span><span class="n">ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">314</span>    <span class="k">global</span> <span class="n">GATEWAY</span>
<span class="linenos">315</span>    <span class="n">GATEWAY</span> <span class="o">=</span> <span class="n">ip</span>
</pre></div>
</div>
</section>
<section id="cassiamqtt-api-mock">
<h2>Cassiamqtt API Mock<a class="headerlink" href="#cassiamqtt-api-mock" title="Link to this heading"></a></h2>
<p>To debug code related to the <code class="docutils literal notranslate"><span class="pre">Cassiamqtt</span> <span class="pre">API</span></code> , you can refer to the following implementation using the <code class="docutils literal notranslate"><span class="pre">mqtt_as</span></code> API to mock the  <code class="docutils literal notranslate"><span class="pre">Cassiamqtt</span> <span class="pre">API</span></code> , which allows for quick testing of basic logic and functionality.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>仅用于本地调试代码基本逻辑，勿用于压力测试和稳定性测试</p></li>
<li><p>The actual script execution results should be based on operation within the M2000 gateway.</p></li>
</ul>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  2</span><span class="sd">Module name: cassiamqtt.py</span>
<span class="linenos">  3</span><span class="sd">Purpose: Local MicroPython debugging mock. Exposes the same high-level API as the real gateway by forwarding calls to mqtt_as interface, so you can develop and test your MicroPython logic on a PC without flashing firmware.</span>
<span class="linenos">  4</span><span class="sd">MicroPython compatibility: v1.24.1</span>
<span class="linenos">  5</span><span class="sd">Important: Do **not** copy this file into the gateway itself—the gateway already contains a native C implementation. This module is **only** for convenient desktop debugging and has no performance guarantees.</span>
<span class="linenos">  6</span><span class="sd">&quot;&quot;&quot;</span>
<span class="linenos">  7</span>
<span class="linenos">  8</span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="linenos">  9</span>
<span class="linenos"> 10</span><span class="kn">from</span><span class="w"> </span><span class="nn">mqtt_as</span><span class="w"> </span><span class="kn">import</span> <span class="n">MQTTClient</span>
<span class="linenos"> 11</span><span class="kn">from</span><span class="w"> </span><span class="nn">cassia_log</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>
<span class="linenos"> 12</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="k">def</span><span class="w"> </span><span class="nf">_parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">):</span>
<span class="linenos"> 15</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 16</span>        <span class="n">host_port</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<span class="linenos"> 17</span>        <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">host_port</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="linenos"> 18</span>        <span class="k">return</span> <span class="p">{</span>
<span class="linenos"> 19</span>            <span class="s2">&quot;host&quot;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
<span class="linenos"> 20</span>            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
<span class="linenos"> 21</span>        <span class="p">}</span>
<span class="linenos"> 22</span>    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<span class="linenos"> 23</span>        <span class="k">return</span> <span class="kc">None</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="k">class</span><span class="w"> </span><span class="nc">CassiaMQTTClient</span><span class="p">:</span>
<span class="linenos"> 27</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="linenos"> 28</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="s2">&quot;__mock_cassiamqtt__&quot;</span><span class="p">)</span>
<span class="linenos"> 29</span>
<span class="linenos"> 30</span>        <span class="n">addr</span> <span class="o">=</span> <span class="n">_parse_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
<span class="linenos"> 31</span>        <span class="k">if</span> <span class="n">addr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 32</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parse uri failed: </span><span class="si">{</span><span class="n">uri</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos"> 33</span>            <span class="k">return</span>
<span class="linenos"> 34</span>
<span class="linenos"> 35</span>        <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 36</span>            <span class="s2">&quot;client_id&quot;</span><span class="p">:</span> <span class="n">client_id</span><span class="p">,</span>
<span class="linenos"> 37</span>            <span class="s2">&quot;server&quot;</span><span class="p">:</span> <span class="n">addr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;host&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="linenos"> 38</span>            <span class="s2">&quot;port&quot;</span><span class="p">:</span> <span class="n">addr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;port&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
<span class="linenos"> 39</span>            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
<span class="linenos"> 40</span>            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
<span class="linenos"> 41</span>            <span class="s2">&quot;keepalive&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
<span class="linenos"> 42</span>            <span class="s2">&quot;ping_interval&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 43</span>            <span class="s2">&quot;ssl&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 44</span>            <span class="s2">&quot;ssl_params&quot;</span><span class="p">:</span> <span class="p">{},</span>
<span class="linenos"> 45</span>            <span class="s2">&quot;response_time&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
<span class="linenos"> 46</span>            <span class="s2">&quot;clean_init&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 47</span>            <span class="s2">&quot;clean&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="linenos"> 48</span>            <span class="s2">&quot;max_repubs&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos"> 49</span>            <span class="s2">&quot;will&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 50</span>            <span class="s2">&quot;subs_cb&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 51</span>            <span class="s2">&quot;ssid&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 52</span>            <span class="s2">&quot;wifi_pw&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 53</span>            <span class="s2">&quot;queue_len&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
<span class="linenos"> 54</span>            <span class="s2">&quot;gateway&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 55</span>            <span class="s2">&quot;mqttv5&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="linenos"> 56</span>            <span class="s2">&quot;mqttv5_con_props&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="linenos"> 57</span>        <span class="p">}</span>
<span class="linenos"> 58</span>
<span class="linenos"> 59</span>        <span class="n">MQTTClient</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="linenos"> 60</span>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">MQTTClient</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
<span class="linenos"> 61</span>
<span class="linenos"> 62</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 63</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos"> 64</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 65</span>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;connect start...&quot;</span><span class="p">)</span>
<span class="linenos"> 66</span>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="linenos"> 67</span>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;connect ok&quot;</span><span class="p">)</span>
<span class="linenos"> 68</span>                <span class="k">break</span>
<span class="linenos"> 69</span>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos"> 70</span>                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;connect failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, wait next retry...&quot;</span><span class="p">)</span>
<span class="linenos"> 71</span>                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="linenos"> 72</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 73</span>
<span class="linenos"> 74</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
<span class="linenos"> 75</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disconnect start&quot;</span><span class="p">)</span>
<span class="linenos"> 76</span>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
<span class="linenos"> 77</span>        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="kc">None</span>
<span class="linenos"> 78</span>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;disconnect ok&quot;</span><span class="p">)</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__aiter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 81</span>        <span class="k">return</span> <span class="bp">self</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__anext__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 84</span>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="linenos"> 85</span>            <span class="k">raise</span> <span class="ne">StopAsyncIteration</span>
<span class="linenos"> 86</span>
<span class="linenos"> 87</span>        <span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">retained</span><span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="fm">__anext__</span><span class="p">()</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span>        <span class="k">return</span> <span class="p">{</span>
<span class="linenos"> 90</span>            <span class="s2">&quot;topic&quot;</span><span class="p">:</span> <span class="n">topic</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
<span class="linenos"> 91</span>            <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span>
<span class="linenos"> 92</span>            <span class="s2">&quot;qos&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 93</span>        <span class="p">}</span>
<span class="linenos"> 94</span>
<span class="linenos"> 95</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="linenos"> 96</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos"> 97</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pub start: </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">qos</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">retain</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">payload</span><span class="p">[:</span><span class="mi">32</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<span class="linenos"> 98</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="n">qos</span><span class="p">,</span> <span class="n">retain</span><span class="o">=</span><span class="n">retain</span><span class="p">)</span>
<span class="linenos"> 99</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pub ok&quot;</span><span class="p">)</span>
<span class="linenos">100</span>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">101</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">102</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pub failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">103</span>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">e</span>
<span class="linenos">104</span>
<span class="linenos">105</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="linenos">106</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">107</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sub start: </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">qos</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">108</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">qos</span><span class="o">=</span><span class="n">qos</span><span class="p">)</span>
<span class="linenos">109</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sub ok&quot;</span><span class="p">)</span>
<span class="linenos">110</span>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">111</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">112</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sub failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">113</span>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">e</span>
<span class="linenos">114</span>
<span class="linenos">115</span>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
<span class="linenos">116</span>        <span class="k">try</span><span class="p">:</span>
<span class="linenos">117</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsub start: </span><span class="si">{</span><span class="n">topic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">118</span>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
<span class="linenos">119</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsub ok&quot;</span><span class="p">)</span>
<span class="linenos">120</span>            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
<span class="linenos">121</span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="linenos">122</span>            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unsub failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="linenos">123</span>            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">e</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="mpy.html" class="btn btn-neutral float-left" title="Compile to mpy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="demo.html" class="btn btn-neutral float-right" title="Complete Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, CassiaNetworks.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Language</span>
    en
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>语言</dt>
      
      
      
      <dd>
        <a href="../../html/more/local_run.html">简体中文</a>
      </dd>
      
      
      
      
    </dl>
    <dl>
      <dt>Versions</dt>
      
      <dd>
        <a href="../../../2.2.mp.2511181547/html_en/more/local_run.html">2.2.mp.2511181547</a>
      </dd>
      
      <dd>
        <a href="../../../2.2.mp.2509291554/html_en/more/local_run.html">2.2.mp.2509291554</a>
      </dd>
      
      <dd>
        <a href="../../../2.2.mp.2509241710/html_en/more/local_run.html">2.2.mp.2509241710</a>
      </dd>
      
      <dd>
        <a href="../../../2.2.mp.2509081030/html_en/more/local_run.html">2.2.mp.2509081030</a>
      </dd>
      
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>